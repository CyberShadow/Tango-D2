<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="../style.css" type="text/css" />
		<title>io/FileSystem.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)

        version:        Initial release: March 2004      
        
        author:         Kris, John Reimer, Chris Sauls (Win95 file support)

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.io.FileSystem;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.os.OS;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.text.Text;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.io.FilePath,
                tango.io.FileConst,
                tango.io.Exception;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.convert.Unicode;

<span class='kw4'>version</span> <span class='opr'>(</span>Win32<span class='opr'>)</span>
        <span class='kw2'>extern</span> <span class='opr'>(</span>Windows<span class='opr'>)</span> DWORD GetLogicalDriveStringsA <span class='opr'>(</span>DWORD, LPTSTR<span class='opr'>)</span>;
     <span class='kw1'>else</span>
        <span class='kw2'>extern</span> <span class='opr'>(</span>C<span class='opr'>)</span> <span class='kw4'>int</span> strlen <span class='opr'>(</span><span class='kw4'>char</span> <span class='opr'>*</span><span class='opr'>)</span>;

<span class='com'>/*******************************************************************************

        Models an OS-specific file-system. Included here are methods to 
        list the system roots (&quot;C:&quot;, &quot;D:&quot;, etc) and to manipulate the
        current working directory.

*******************************************************************************/</span>

<span class='kw4'>class</span> FileSystem
<span class='opr'>{</span>
        <span class='kw4'>version</span> <span class='opr'>(</span>Win32<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='com'>/***********************************************************************
                        
                        List the set of root devices (C:, D: etc)

                ***********************************************************************/</span>

                <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> listRoots <span class='opr'>(</span><span class='opr'>)</span>
                <span class='opr'>{</span>
                        <span class='kw4'>int</span>             len;
                        <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span>          str;
                        <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span>        roots;

                        <span class='com'>// acquire drive strings</span>
                        len <span class='opr'>=</span> GetLogicalDriveStringsA <span class='opr'>(</span><span class='nbr'>0</span>, <span class='kw2'>null</span><span class='opr'>)</span>;
                        <span class='kw1'>if</span> <span class='opr'>(</span>len<span class='opr'>)</span>
                           <span class='opr'>{</span>
                           str <span class='opr'>=</span> <span class='kw2'>new</span> <span class='kw4'>char</span> <span class='opr'>[</span>len<span class='opr'>]</span>;
                           GetLogicalDriveStringsA <span class='opr'>(</span>len, str<span class='opr'>)</span>;

                           <span class='com'>// split roots into seperate strings</span>
                           roots <span class='opr'>=</span> Text.split <span class='opr'>(</span>str <span class='opr'>[</span><span class='nbr'>0.</span>.str.length<span class='opr'>-</span><span class='nbr'>1</span><span class='opr'>]</span>, <span class='str'>&quot;\0&quot;</span><span class='opr'>)</span>;
                           <span class='opr'>}</span>
                        <span class='kw1'>return</span> roots;
                <span class='opr'>}</span>

                <span class='com'>/***********************************************************************

                        Set the current working directory

                ***********************************************************************/</span>

                <span class='kw4'>static</span> <span class='kw4'>void</span> setDirectory <span class='opr'>(</span>FilePath fp<span class='opr'>)</span>
                <span class='opr'>{</span>
                        <span class='kw4'>version</span> <span class='opr'>(</span>Win32SansUnicode<span class='opr'>)</span>
                                <span class='opr'>{</span>
                                <span class='kw1'>if</span> <span class='opr'>(</span>! SetCurrentDirectoryA <span class='opr'>(</span>fp.toUtf8<span class='opr'>)</span><span class='opr'>)</span>
                                       <span class='kw2'>throw</span> <span class='kw2'>new</span> IOException <span class='opr'>(</span><span class='str'>&quot;Failed to set current directory&quot;</span><span class='opr'>)</span>;
                                <span class='opr'>}</span>
                             <span class='kw1'>else</span>
                                <span class='opr'>{</span>
                                <span class='kw1'>if</span> <span class='opr'>(</span>! SetCurrentDirectoryW <span class='opr'>(</span>fp.toUtf16<span class='opr'>)</span><span class='opr'>)</span>
                                      <span class='kw2'>throw</span> <span class='kw2'>new</span> IOException <span class='opr'>(</span><span class='str'>&quot;Failed to set current directory&quot;</span><span class='opr'>)</span>;
                                <span class='opr'>}</span>
                <span class='opr'>}</span>

                <span class='com'>/***********************************************************************

                        Get the current working directory
                
                ***********************************************************************/</span>

                <span class='kw4'>static</span> FilePath getDirectory <span class='opr'>(</span><span class='opr'>)</span>
                <span class='opr'>{</span>
                        <span class='kw4'>version</span> <span class='opr'>(</span>Win32SansUnicode<span class='opr'>)</span>
                                <span class='opr'>{</span>
                                <span class='kw4'>int</span> length <span class='opr'>=</span> GetCurrentDirectoryA <span class='opr'>(</span><span class='nbr'>0</span>, <span class='kw2'>null</span><span class='opr'>)</span>;
                                <span class='kw1'>if</span> <span class='opr'>(</span>length<span class='opr'>)</span>
                                   <span class='opr'>{</span>
                                   <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> dir <span class='opr'>=</span> <span class='kw2'>new</span> <span class='kw4'>char</span> <span class='opr'>[</span>length<span class='opr'>]</span>;
                                   GetCurrentDirectoryA <span class='opr'>(</span>length, dir<span class='opr'>)</span>;
                                   <span class='kw1'>return</span> <span class='kw2'>new</span> FilePath <span class='opr'>(</span>dir, <span class='kw2'>false</span><span class='opr'>)</span>;
                                   <span class='opr'>}</span>
                                <span class='opr'>}</span>
                             <span class='kw1'>else</span>
                                <span class='opr'>{</span>
                                <span class='kw4'>int</span> length <span class='opr'>=</span> GetCurrentDirectoryW <span class='opr'>(</span><span class='nbr'>0</span>, <span class='kw2'>null</span><span class='opr'>)</span>;
                                <span class='kw1'>if</span> <span class='opr'>(</span>length<span class='opr'>)</span>
                                   <span class='opr'>{</span>
                                   <span class='kw4'>wchar</span><span class='opr'>[</span><span class='opr'>]</span> dir <span class='opr'>=</span> <span class='kw2'>new</span> <span class='kw4'>wchar</span> <span class='opr'>[</span>length<span class='opr'>]</span>;
                                   GetCurrentDirectoryW <span class='opr'>(</span>length, dir<span class='opr'>)</span>;
                                   <span class='kw1'>return</span> <span class='kw2'>new</span> FilePath <span class='opr'>(</span>Unicode.toUtf8 <span class='opr'>(</span>dir<span class='opr'>)</span>, <span class='kw2'>false</span><span class='opr'>)</span>;
                                   <span class='opr'>}</span>
                                <span class='opr'>}</span>
                        <span class='kw2'>throw</span> <span class='kw2'>new</span> IOException <span class='opr'>(</span><span class='str'>&quot;Failed to get current directory&quot;</span><span class='opr'>)</span>;
                <span class='opr'>}</span>
        <span class='opr'>}</span>
        
        
        <span class='kw4'>version</span> <span class='opr'>(</span>Posix<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='com'>/***********************************************************************

                        List the set of root devices.

                        @todo not currently implemented.

                ***********************************************************************/</span>

                <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> listRoots <span class='opr'>(</span><span class='opr'>)</span>
                <span class='opr'>{</span>
                        <span class='kw2'>assert</span><span class='opr'>(</span><span class='nbr'>0</span><span class='opr'>)</span>;
                        <span class='kw1'>return</span> <span class='kw2'>null</span>;
                <span class='opr'>}</span>

                <span class='com'>/***********************************************************************

                        Set the current working directory

                ***********************************************************************/</span>

                <span class='kw4'>static</span> <span class='kw4'>void</span> setDirectory <span class='opr'>(</span>FilePath fp<span class='opr'>)</span>
                <span class='opr'>{</span>
                        <span class='kw1'>if</span> <span class='opr'>(</span>tango.stdc.posix.posix.chdir <span class='opr'>(</span>fp.toUtf8<span class='opr'>)</span><span class='opr'>)</span>
                            <span class='kw2'>throw</span> <span class='kw2'>new</span> IOException <span class='opr'>(</span><span class='str'>&quot;Failed to set current directory&quot;</span><span class='opr'>)</span>;
                <span class='opr'>}</span>

                <span class='com'>/***********************************************************************

                        Get the current working directory
                
                ***********************************************************************/</span>

                <span class='kw4'>static</span> FilePath getDirectory <span class='opr'>(</span><span class='opr'>)</span>
                <span class='opr'>{</span>
                        <span class='kw4'>char</span> <span class='opr'>*</span>s <span class='opr'>=</span> tango.stdc.posix.posix.getcwd <span class='opr'>(</span><span class='kw2'>null</span>, <span class='nbr'>0</span><span class='opr'>)</span>;
                        <span class='kw1'>if</span> <span class='opr'>(</span>s<span class='opr'>)</span> 
                            <span class='kw1'>return</span> <span class='kw2'>new</span> FilePath <span class='opr'>(</span>s<span class='opr'>[</span><span class='nbr'>0.</span>.strlen<span class='opr'>(</span>s<span class='opr'>)</span><span class='opr'>]</span><span class='opr'>)</span>;

                        <span class='kw2'>throw</span> <span class='kw2'>new</span> IOException <span class='opr'>(</span><span class='str'>&quot;Failed to get current directory&quot;</span><span class='opr'>)</span>;
                <span class='opr'>}</span>
        <span class='opr'>}</span>   
<span class='opr'>}</span>
</pre></td></tr></table>	</body>
</html>
