<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="../style.css" type="text/css" />
		<title>convert/DGDouble.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)
        
        version:        Initial release: Feb 2005

        author:         Kris

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.convert.DGDouble;

<span class='com'>/*******************************************************************************
        
        External requirements for this package    

*******************************************************************************/</span>

<span class='kw2'>extern</span> <span class='opr'>(</span>C<span class='opr'>)</span>
<span class='opr'>{</span>
        <span class='com'>// these should be linked in via dtoa.c</span>
        <span class='kw4'>char</span><span class='opr'>*</span>  dtoa <span class='opr'>(</span><span class='kw4'>double</span> d, <span class='kw4'>int</span> mode, <span class='kw4'>int</span> ndigits, <span class='kw4'>int</span><span class='opr'>*</span> decpt, <span class='kw4'>int</span><span class='opr'>*</span> sign, <span class='kw4'>char</span><span class='opr'>*</span><span class='opr'>*</span> rve<span class='opr'>)</span>;
        <span class='kw4'>double</span> atod <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>*</span> s00, <span class='kw4'>int</span> len, <span class='kw4'>char</span><span class='opr'>*</span><span class='opr'>*</span> se<span class='opr'>)</span>;


        <span class='com'>// callback for dtoa allocation function</span>
        <span class='kw4'>void</span><span class='opr'>*</span> __dToaMalloc <span class='opr'>(</span><span class='kw4'>uint</span> size<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>throw</span> <span class='kw2'>new</span> Exception <span class='opr'>(</span><span class='str'>&quot;unexpected memory request from DGDouble&quot;</span><span class='opr'>)</span>;
                <span class='com'>//return new byte[2048];</span>
        <span class='opr'>}</span>
<span class='opr'>}</span>


<span class='com'>/******************************************************************************

        David Gay's extended conversions between string and floating-point
        numeric representations. Use these where you need extended accuracy
        for convertions. 

        Note that this class requires the attendent file dtoa.c be compiled 
        and linked to the application.

        While these functions are all static, they are encapsulated within 
        a class inheritance to preserve some namespace cohesion. One might 
        use structs for encapsualtion instead, but then inheritance would 
        be lost. Note that the root class, Styled, is abstract to prevent 
        accidental instantiation of these classes.

******************************************************************************/</span>

<span class='kw4'>struct</span> DGDouble
<span class='opr'>{</span>
        <span class='com'>/**********************************************************************

                Convert a formatted string of digits to a floating-
                point number. 

        **********************************************************************/</span>

        <span class='kw4'>final</span> <span class='kw4'>static</span> <span class='kw4'>double</span> parse <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> src, <span class='kw4'>uint</span><span class='opr'>*</span> ate<span class='opr'>=</span><span class='kw2'>null</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw4'>char</span><span class='opr'>*</span> end;

                <span class='kw4'>double</span> x <span class='opr'>=</span> atod <span class='opr'>(</span>src.ptr, src.length, <span class='opr'>&amp;</span>end<span class='opr'>)</span>;
                <span class='kw1'>if</span> <span class='opr'>(</span>ate<span class='opr'>)</span>
                    <span class='opr'>*</span>ate <span class='opr'>=</span> end <span class='opr'>-</span> src.ptr;
                <span class='kw1'>return</span> x;
        <span class='opr'>}</span>


        <span class='com'>/**********************************************************************

                Signature for use with Format module

        **********************************************************************/</span>

        <span class='kw4'>static</span> <span class='kw4'>final</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> dst, <span class='kw4'>double</span> x, <span class='kw4'>uint</span> decimals, <span class='kw4'>bool</span> scientific<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> format <span class='opr'>(</span>dst, x, decimals, scientific, <span class='nbr'>3</span><span class='opr'>)</span>;
        <span class='opr'>}</span>


        <span class='com'>/**********************************************************************

                Convert a floating-point number to a string. Parameter 'mode'
                should be specified thusly:

        0 ==&gt; shortest string that yields d when read in
            and rounded to nearest.

        1 ==&gt; like 0, but with Steele &amp; White stopping rule;
            e.g. with IEEE P754 arithmetic , mode 0 gives
            1e23 whereas mode 1 gives 9.999999999999999e22.

        2 ==&gt; max(1,ndigits) significant digits.  This gives a
            return value similar to that of ecvt, except
            that trailing zeros are suppressed.

        3 ==&gt; through ndigits past the decimal point.  This
            gives a return value similar to that from fcvt,
            except that trailing zeros are suppressed, and
            ndigits can be negative.

        4,5 ==&gt; similar to 2 and 3, respectively, but (in
            round-nearest mode) with the tests of mode 0 to
            possibly return a shorter string that rounds to d.
            With IEEE arithmetic and compilation with
            -DHonor_FLT_ROUNDS, modes 4 and 5 behave the same
            as modes 2 and 3 when FLT_ROUNDS != 1.

        6-9 ==&gt; Debugging modes similar to mode - 4:  don't try
            fast floating-point estimate (if applicable).

        **********************************************************************/</span>

        <span class='kw4'>static</span> <span class='kw4'>final</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> dst, <span class='kw4'>double</span> x, <span class='kw4'>uint</span> decimals <span class='opr'>=</span> <span class='nbr'>6</span>, <span class='kw4'>bool</span> scientific <span class='opr'>=</span> <span class='kw2'>false</span>, <span class='kw4'>uint</span> mode<span class='opr'>=</span><span class='nbr'>3</span><span class='opr'>)</span>
        <span class='kw2'>in</span> <span class='opr'>{</span>
           <span class='kw2'>assert</span> <span class='opr'>(</span>dst.length <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>32</span><span class='opr'>)</span>;
           <span class='opr'>}</span>
        <span class='kw2'>body</span>
        <span class='opr'>{</span>
                <span class='kw4'>char</span><span class='opr'>*</span>   end,
                        str;
                <span class='kw4'>int</span>     sign,
                        decpt;
                  
                str <span class='opr'>=</span> dtoa <span class='opr'>(</span>x, mode, decimals, <span class='opr'>&amp;</span>decpt, <span class='opr'>&amp;</span>sign, <span class='opr'>&amp;</span>end<span class='opr'>)</span>;
                
                <span class='kw4'>char</span> <span class='opr'>*</span>p <span class='opr'>=</span> dst;
                <span class='kw4'>int</span> len <span class='opr'>=</span> end <span class='opr'>-</span> str;

                <span class='kw1'>if</span> <span class='opr'>(</span>sign<span class='opr'>)</span>
                    <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'-'</span>;

                <span class='kw1'>if</span> <span class='opr'>(</span>decpt <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>9999</span><span class='opr'>)</span>
                    p<span class='opr'>[</span><span class='nbr'>0.</span>.len<span class='opr'>]</span> <span class='opr'>=</span> str<span class='opr'>[</span><span class='nbr'>0.</span>.len<span class='opr'>]</span>;
                <span class='kw1'>else</span>
                   <span class='opr'>{</span>
                   <span class='kw4'>int</span> exp <span class='opr'>=</span> decpt <span class='opr'>-</span> <span class='nbr'>1</span>;
                   sign <span class='opr'>=</span> <span class='nbr'>0</span>;
                   <span class='kw1'>if</span> <span class='opr'>(</span>exp <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
                      <span class='opr'>{</span>
                      exp <span class='opr'>=</span> <span class='opr'>-</span>exp;
                      sign <span class='opr'>=</span> <span class='nbr'>1</span>;
                      <span class='opr'>}</span>

                   <span class='com'>// force scientific format if too long ...</span>
                   <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>exp <span class='opr'>+</span> len <span class='opr'>+</span> <span class='nbr'>2</span><span class='opr'>)</span> <span class='opr'>&gt;</span> dst.length<span class='opr'>)</span>
                        scientific <span class='opr'>=</span> <span class='kw2'>true</span>;

                   <span class='kw1'>if</span> <span class='opr'>(</span>scientific<span class='opr'>)</span>
                      <span class='opr'>{</span>
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>*</span>str<span class='opr'>+</span><span class='opr'>+</span>;
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'.'</span>;
                      <span class='kw1'>while</span> <span class='opr'>(</span>str <span class='opr'>&lt;</span> end<span class='opr'>)</span>
                             <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>*</span>str<span class='opr'>+</span><span class='opr'>+</span>;
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'e'</span>;
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>(</span>sign<span class='opr'>)</span> ? <span class='str'>'-'</span> : <span class='str'>'+'</span>;
   
                      <span class='kw1'>if</span> <span class='opr'>(</span>exp <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>100</span><span class='opr'>)</span>
                         <span class='opr'>{</span>
                         <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> exp / <span class='nbr'>100</span> <span class='opr'>+</span> <span class='str'>'0'</span>;
                         exp <span class='opr'>%</span><span class='opr'>=</span> <span class='nbr'>100</span>;
                         <span class='opr'>}</span>
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> exp / <span class='nbr'>10</span> <span class='opr'>+</span> <span class='str'>'0'</span>;
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> exp <span class='opr'>%</span> <span class='nbr'>10</span> <span class='opr'>+</span> <span class='str'>'0'</span>;
                      <span class='opr'>}</span>
                   <span class='kw1'>else</span>
                      <span class='opr'>{</span>
                      <span class='kw1'>if</span> <span class='opr'>(</span>decpt <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                          <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'0'</span>;
                      <span class='kw1'>else</span>
                         <span class='opr'>{</span>
                         <span class='kw1'>while</span> <span class='opr'>(</span>decpt <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
                               <span class='opr'>{</span>
                               <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>(</span>str <span class='opr'>&lt;</span> end<span class='opr'>)</span> ? <span class='opr'>*</span>str<span class='opr'>+</span><span class='opr'>+</span> : <span class='str'>'0'</span>;
                               <span class='opr'>-</span><span class='opr'>-</span>decpt;
                               <span class='opr'>}</span>
                         <span class='opr'>}</span>
                      <span class='kw1'>if</span> <span class='opr'>(</span>str <span class='opr'>&lt;</span> end<span class='opr'>)</span>
                         <span class='opr'>{</span>
                         <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'.'</span>;
                         <span class='kw1'>while</span> <span class='opr'>(</span>decpt <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
                               <span class='opr'>{</span>
                               <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'0'</span>;
                               <span class='opr'>+</span><span class='opr'>+</span>decpt;
                               <span class='opr'>}</span>
                         <span class='kw1'>while</span> <span class='opr'>(</span>str <span class='opr'>&lt;</span> end<span class='opr'>)</span>
                                <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>*</span>str<span class='opr'>+</span><span class='opr'>+</span>;
                         <span class='opr'>}</span>
                      <span class='opr'>}</span> 
                   <span class='opr'>}</span>
                         
                <span class='kw1'>return</span> dst<span class='opr'>[</span><span class='nbr'>0.</span>.<span class='opr'>(</span>p <span class='opr'>-</span> dst.ptr<span class='opr'>)</span><span class='opr'>]</span>;
        <span class='opr'>}</span>
<span class='opr'>}</span>


</pre></td></tr></table>	</body>
</html>
