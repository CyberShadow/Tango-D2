<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<title>convert/DGDouble.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
<span>43</span>
<span>44</span>
<span>45</span>
<span>46</span>
<span>47</span>
<span>48</span>
<span>49</span>
<span>50</span>
<span>51</span>
<span>52</span>
<span>53</span>
<span>54</span>
<span>55</span>
<span>56</span>
<span>57</span>
<span>58</span>
<span>59</span>
<span>60</span>
<span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)
        
        version:        Initial release: Feb 2005

        author:         Kris

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.convert.DGDouble;

<span class='com'>/*******************************************************************************
        
        External requirements for this package    

*******************************************************************************/</span>

<span class='kw2'>extern</span> <span class='opr'>(</span>C<span class='opr'>)</span>
<span class='opr'>{</span>
        <span class='com'>// these should be linked in via dtoa.c</span>
        <span class='kw4'>char</span><span class='opr'>*</span>  dtoa <span class='opr'>(</span><span class='kw4'>double</span> d, <span class='kw4'>int</span> mode, <span class='kw4'>int</span> ndigits, <span class='kw4'>int</span><span class='opr'>*</span> decpt, <span class='kw4'>int</span><span class='opr'>*</span> sign, <span class='kw4'>char</span><span class='opr'>*</span><span class='opr'>*</span> rve<span class='opr'>)</span>;
        <span class='kw4'>double</span> atod <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>*</span> s00, <span class='kw4'>int</span> len, <span class='kw4'>char</span><span class='opr'>*</span><span class='opr'>*</span> se<span class='opr'>)</span>;


        <span class='com'>// callback for dtoa allocation function</span>
        <span class='kw4'>void</span><span class='opr'>*</span> __dToaMalloc <span class='opr'>(</span><span class='kw4'>uint</span> size<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>throw</span> <span class='kw2'>new</span> Exception <span class='opr'>(</span><span class='str'>&quot;unexpected memory request from DGDouble&quot;</span><span class='opr'>)</span>;
                <span class='com'>//return new byte[2048];</span>
        <span class='opr'>}</span>
<span class='opr'>}</span>


<span class='com'>/******************************************************************************

        David Gay's extended conversions between string and floating-point
        numeric representations. Use these where you need extended accuracy
        for convertions. 

        Note that this class requires the attendent file dtoa.c be compiled 
        and linked to the application.

        While these functions are all static, they are encapsulated within 
        a class inheritance to preserve some namespace cohesion. One might 
        use structs for encapsualtion instead, but then inheritance would 
        be lost. Note that the root class, Styled, is abstract to prevent 
        accidental instantiation of these classes.

******************************************************************************/</span>

<span class='kw4'>struct</span> DGDouble
<span class='opr'>{</span>
        <span class='com'>/**********************************************************************

                Convert a formatted string of digits to a floating-
                point number. 

        **********************************************************************/</span>

        <span class='kw4'>final</span> <span class='kw4'>static</span> <span class='kw4'>double</span> parse <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> src, <span class='kw4'>uint</span><span class='opr'>*</span> ate<span class='opr'>=</span><span class='kw2'>null</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw4'>char</span><span class='opr'>*</span> end;

                <span class='kw4'>double</span> x <span class='opr'>=</span> atod <span class='opr'>(</span>src.ptr, src.length, <span class='opr'>&amp;</span>end<span class='opr'>)</span>;
                <span class='kw1'>if</span> <span class='opr'>(</span>ate<span class='opr'>)</span>
                    <span class='opr'>*</span>ate <span class='opr'>=</span> end <span class='opr'>-</span> src.ptr;
                <span class='kw1'>return</span> x;
        <span class='opr'>}</span>


        <span class='com'>/**********************************************************************

                Signature for use with Format module

        **********************************************************************/</span>

        <span class='kw4'>static</span> <span class='kw4'>final</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> dst, <span class='kw4'>double</span> x, <span class='kw4'>uint</span> decimals, <span class='kw4'>bool</span> scientific<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> format <span class='opr'>(</span>dst, x, decimals, scientific, <span class='nbr'>3</span><span class='opr'>)</span>;
        <span class='opr'>}</span>


        <span class='com'>/**********************************************************************

                Convert a floating-point number to a string. Parameter 'mode'
                should be specified thusly:

        0 ==&gt; shortest string that yields d when read in
            and rounded to nearest.

        1 ==&gt; like 0, but with Steele &amp; White stopping rule;
            e.g. with IEEE P754 arithmetic , mode 0 gives
            1e23 whereas mode 1 gives 9.999999999999999e22.

        2 ==&gt; max(1,ndigits) significant digits.  This gives a
            return value similar to that of ecvt, except
            that trailing zeros are suppressed.

        3 ==&gt; through ndigits past the decimal point.  This
            gives a return value similar to that from fcvt,
            except that trailing zeros are suppressed, and
            ndigits can be negative.

        4,5 ==&gt; similar to 2 and 3, respectively, but (in
            round-nearest mode) with the tests of mode 0 to
            possibly return a shorter string that rounds to d.
            With IEEE arithmetic and compilation with
            -DHonor_FLT_ROUNDS, modes 4 and 5 behave the same
            as modes 2 and 3 when FLT_ROUNDS != 1.

        6-9 ==&gt; Debugging modes similar to mode - 4:  don't try
            fast floating-point estimate (if applicable).

        **********************************************************************/</span>

        <span class='kw4'>static</span> <span class='kw4'>final</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> dst, <span class='kw4'>double</span> x, <span class='kw4'>uint</span> decimals <span class='opr'>=</span> <span class='nbr'>6</span>, <span class='kw4'>bool</span> scientific <span class='opr'>=</span> <span class='kw2'>false</span>, <span class='kw4'>uint</span> mode<span class='opr'>=</span><span class='nbr'>3</span><span class='opr'>)</span>
        <span class='kw2'>in</span> <span class='opr'>{</span>
           <span class='kw2'>assert</span> <span class='opr'>(</span>dst.length <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>32</span><span class='opr'>)</span>;
           <span class='opr'>}</span>
        <span class='kw2'>body</span>
        <span class='opr'>{</span>
                <span class='kw4'>char</span><span class='opr'>*</span>   end,
                        str;
                <span class='kw4'>int</span>     sign,
                        decpt;
                  
                str <span class='opr'>=</span> dtoa <span class='opr'>(</span>x, mode, decimals, <span class='opr'>&amp;</span>decpt, <span class='opr'>&amp;</span>sign, <span class='opr'>&amp;</span>end<span class='opr'>)</span>;
                
                <span class='kw4'>char</span> <span class='opr'>*</span>p <span class='opr'>=</span> dst;
                <span class='kw4'>int</span> len <span class='opr'>=</span> end <span class='opr'>-</span> str;

                <span class='kw1'>if</span> <span class='opr'>(</span>sign<span class='opr'>)</span>
                    <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'-'</span>;

                <span class='kw1'>if</span> <span class='opr'>(</span>decpt <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>9999</span><span class='opr'>)</span>
                    p<span class='opr'>[</span><span class='nbr'>0.</span>.len<span class='opr'>]</span> <span class='opr'>=</span> str<span class='opr'>[</span><span class='nbr'>0.</span>.len<span class='opr'>]</span>;
                <span class='kw1'>else</span>
                   <span class='opr'>{</span>
                   <span class='kw4'>int</span> exp <span class='opr'>=</span> decpt <span class='opr'>-</span> <span class='nbr'>1</span>;
                   sign <span class='opr'>=</span> <span class='nbr'>0</span>;
                   <span class='kw1'>if</span> <span class='opr'>(</span>exp <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
                      <span class='opr'>{</span>
                      exp <span class='opr'>=</span> <span class='opr'>-</span>exp;
                      sign <span class='opr'>=</span> <span class='nbr'>1</span>;
                      <span class='opr'>}</span>

                   <span class='com'>// force scientific format if too long ...</span>
                   <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>exp <span class='opr'>+</span> len <span class='opr'>+</span> <span class='nbr'>2</span><span class='opr'>)</span> <span class='opr'>&gt;</span> dst.length<span class='opr'>)</span>
                        scientific <span class='opr'>=</span> <span class='kw2'>true</span>;

                   <span class='kw1'>if</span> <span class='opr'>(</span>scientific<span class='opr'>)</span>
                      <span class='opr'>{</span>
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>*</span>str<span class='opr'>+</span><span class='opr'>+</span>;
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'.'</span>;
                      <span class='kw1'>while</span> <span class='opr'>(</span>str <span class='opr'>&lt;</span> end<span class='opr'>)</span>
                             <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>*</span>str<span class='opr'>+</span><span class='opr'>+</span>;
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'e'</span>;
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>(</span>sign<span class='opr'>)</span> ? <span class='str'>'-'</span> : <span class='str'>'+'</span>;
   
                      <span class='kw1'>if</span> <span class='opr'>(</span>exp <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>100</span><span class='opr'>)</span>
                         <span class='opr'>{</span>
                         <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> exp / <span class='nbr'>100</span> <span class='opr'>+</span> <span class='str'>'0'</span>;
                         exp <span class='opr'>%</span><span class='opr'>=</span> <span class='nbr'>100</span>;
                         <span class='opr'>}</span>
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> exp / <span class='nbr'>10</span> <span class='opr'>+</span> <span class='str'>'0'</span>;
                      <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> exp <span class='opr'>%</span> <span class='nbr'>10</span> <span class='opr'>+</span> <span class='str'>'0'</span>;
                      <span class='opr'>}</span>
                   <span class='kw1'>else</span>
                      <span class='opr'>{</span>
                      <span class='kw1'>if</span> <span class='opr'>(</span>decpt <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                          <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'0'</span>;
                      <span class='kw1'>else</span>
                         <span class='opr'>{</span>
                         <span class='kw1'>while</span> <span class='opr'>(</span>decpt <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
                               <span class='opr'>{</span>
                               <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>(</span>str <span class='opr'>&lt;</span> end<span class='opr'>)</span> ? <span class='opr'>*</span>str<span class='opr'>+</span><span class='opr'>+</span> : <span class='str'>'0'</span>;
                               <span class='opr'>-</span><span class='opr'>-</span>decpt;
                               <span class='opr'>}</span>
                         <span class='opr'>}</span>
                      <span class='kw1'>if</span> <span class='opr'>(</span>str <span class='opr'>&lt;</span> end<span class='opr'>)</span>
                         <span class='opr'>{</span>
                         <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'.'</span>;
                         <span class='kw1'>while</span> <span class='opr'>(</span>decpt <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
                               <span class='opr'>{</span>
                               <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='str'>'0'</span>;
                               <span class='opr'>+</span><span class='opr'>+</span>decpt;
                               <span class='opr'>}</span>
                         <span class='kw1'>while</span> <span class='opr'>(</span>str <span class='opr'>&lt;</span> end<span class='opr'>)</span>
                                <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>*</span>str<span class='opr'>+</span><span class='opr'>+</span>;
                         <span class='opr'>}</span>
                      <span class='opr'>}</span> 
                   <span class='opr'>}</span>
                         
                <span class='kw1'>return</span> dst<span class='opr'>[</span><span class='nbr'>0.</span>.<span class='opr'>(</span>p <span class='opr'>-</span> dst.ptr<span class='opr'>)</span><span class='opr'>]</span>;
        <span class='opr'>}</span>
<span class='opr'>}</span>


</pre></td></tr></table>	</body>
</html>
