<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<title>net/http/HttpCookies.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
<span>43</span>
<span>44</span>
<span>45</span>
<span>46</span>
<span>47</span>
<span>48</span>
<span>49</span>
<span>50</span>
<span>51</span>
<span>52</span>
<span>53</span>
<span>54</span>
<span>55</span>
<span>56</span>
<span>57</span>
<span>58</span>
<span>59</span>
<span>60</span>
<span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)

        version:        Initial release: April 2004      
        
        author:         Kris

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.net.http.HttpCookies;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.stdc.ctype;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.io.Buffer;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.text.Text,
                tango.text.Iterator;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.io.protocol.model.IWriter,
                tango.io.model.IBuffer,
                tango.io.model.IConduit;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.convert.Integer;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.net.http.HttpWriter;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.net.http.HttpHeaders;


<span class='com'>/*******************************************************************************

        Defines the Cookie class, and the means for reading &amp; writing them.
        Cookie implementation conforms with RFC 2109, but supports parsing 
        of server-side cookies only. Client-side cookies are supported in
        terms of output, but response parsing is not yet implemented ...

        See over &lt;A HREF=&quot;http://www.faqs.org/rfcs/rfc2109.html&quot;&gt;here&lt;/A&gt;
        for the RFC document.        

*******************************************************************************/</span>

<span class='kw4'>class</span> Cookie : IWritable
<span class='opr'>{</span>
        <span class='kw4'>private</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span>  name,
                        path,
                        value,
                        domain,
                        comment;
        <span class='kw4'>private</span> <span class='kw4'>uint</span>    vrsn<span class='opr'>=</span><span class='nbr'>1</span>;              <span class='com'>// 'version' is a reserved word</span>
        <span class='kw4'>private</span> <span class='kw4'>long</span>    maxAge;
        <span class='kw4'>private</span> <span class='kw4'>bool</span>    secure;

        <span class='com'>/***********************************************************************
                
                Construct an empty client-side cookie. You add these
                to an output request using HttpClient.addCookie(), or
                the equivalent.

        ***********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Construct a cookie with the provided attributes. You add 
                these to an output request using HttpClient.addCookie(), 
                or the equivalent.

        ***********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> name, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> value<span class='opr'>)</span>
        <span class='opr'>{</span>
                setName <span class='opr'>(</span>name<span class='opr'>)</span>;
                setValue <span class='opr'>(</span>value<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Set the name of this cookie

        ***********************************************************************/</span>

        <span class='kw4'>void</span> setName <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> name<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.name <span class='opr'>=</span> name;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Set the value of this cookie

        ***********************************************************************/</span>

        <span class='kw4'>void</span> setValue <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> value<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.value <span class='opr'>=</span> value;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
                
                Set the version of this cookie

        ***********************************************************************/</span>

        <span class='kw4'>void</span> setVersion <span class='opr'>(</span><span class='kw4'>uint</span> vrsn<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.vrsn <span class='opr'>=</span> vrsn;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Set the path of this cookie

        ***********************************************************************/</span>

        <span class='kw4'>void</span> setPath <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> path<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.path <span class='opr'>=</span> path;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Set the domain of this cookie

        ***********************************************************************/</span>

        <span class='kw4'>void</span> setDomain <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> domain<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.domain <span class='opr'>=</span> domain;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Set the comment associated with this cookie

        ***********************************************************************/</span>

        <span class='kw4'>void</span> setComment <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> comment<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.comment <span class='opr'>=</span> comment;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Set the maximum duration of this cookie

        ***********************************************************************/</span>

        <span class='kw4'>void</span> setMaxAge <span class='opr'>(</span><span class='kw4'>long</span> maxAge<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.maxAge <span class='opr'>=</span> maxAge;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Indicate wether this cookie should be considered secure or not

        ***********************************************************************/</span>

        <span class='kw4'>void</span> setSecure <span class='opr'>(</span><span class='kw4'>bool</span> secure<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.secure <span class='opr'>=</span> secure;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Output the cookie as a text stream, via the provided IWriter.

        ***********************************************************************/</span>

        <span class='kw4'>void</span> write <span class='opr'>(</span>IWriter writer<span class='opr'>)</span>
        <span class='opr'>{</span>
                writer.put <span class='opr'>(</span>name<span class='opr'>)</span>;

                <span class='kw1'>if</span> <span class='opr'>(</span>value.length<span class='opr'>)</span>
                    writer.put <span class='opr'>(</span><span class='str'>'='</span><span class='opr'>)</span>.put<span class='opr'>(</span>value<span class='opr'>)</span>;

                <span class='kw1'>if</span> <span class='opr'>(</span>path.length<span class='opr'>)</span>
                    writer.put <span class='opr'>(</span><span class='str'>&quot;;Path=&quot;</span>c<span class='opr'>)</span>.put<span class='opr'>(</span>path<span class='opr'>)</span>;

                <span class='kw1'>if</span> <span class='opr'>(</span>domain.length<span class='opr'>)</span>
                    writer.put <span class='opr'>(</span><span class='str'>&quot;;Domain=&quot;</span>c<span class='opr'>)</span>.put<span class='opr'>(</span>domain<span class='opr'>)</span>;

                <span class='kw1'>if</span> <span class='opr'>(</span>vrsn<span class='opr'>)</span>
                   <span class='opr'>{</span>
                   <span class='kw4'>char</span><span class='opr'>[</span><span class='nbr'>32</span><span class='opr'>]</span> tmp;

                   writer.put <span class='opr'>(</span><span class='str'>&quot;;Version=&quot;</span>c<span class='opr'>)</span>.put<span class='opr'>(</span>Integer.format<span class='opr'>(</span>tmp, vrsn<span class='opr'>)</span><span class='opr'>)</span>;

                   <span class='kw1'>if</span> <span class='opr'>(</span>comment.length<span class='opr'>)</span>
                       writer.put <span class='opr'>(</span><span class='str'>&quot;;Comment=\&quot;&quot;</span>c<span class='opr'>)</span>.put<span class='opr'>(</span>comment<span class='opr'>)</span>.put<span class='opr'>(</span><span class='str'>'&quot;'</span><span class='opr'>)</span>;

                   <span class='kw1'>if</span> <span class='opr'>(</span>secure<span class='opr'>)</span>
                       writer.put <span class='opr'>(</span><span class='str'>&quot;;Secure&quot;</span>c<span class='opr'>)</span>;

                   <span class='kw1'>if</span> <span class='opr'>(</span>maxAge <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                       writer.put <span class='opr'>(</span><span class='str'>&quot;;Max-Age=&quot;</span>c<span class='opr'>)</span>.put<span class='opr'>(</span>Integer.format<span class='opr'>(</span>tmp, maxAge<span class='opr'>)</span><span class='opr'>)</span>;
                   <span class='opr'>}</span>
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Reset this cookie

        ***********************************************************************/</span>

        <span class='kw4'>void</span> clear <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                maxAge <span class='opr'>=</span> <span class='nbr'>0</span>;
                vrsn <span class='opr'>=</span> <span class='nbr'>1</span>;
                secure <span class='opr'>=</span> <span class='kw2'>false</span>;
                name <span class='opr'>=</span> path <span class='opr'>=</span> domain <span class='opr'>=</span> comment <span class='opr'>=</span> <span class='kw2'>null</span>;
        <span class='opr'>}</span>
<span class='opr'>}</span>



<span class='com'>/*******************************************************************************

        Implements a stack of cookies. Each cookie is pushed onto the
        stack by a parser, which takes its input from HttpHeaders. The
        stack can be populated for both client and server side cookies.

*******************************************************************************/</span>

<span class='kw4'>class</span> CookieStack
<span class='opr'>{</span>
        <span class='kw4'>private</span> <span class='kw4'>int</span>             depth;
        <span class='kw4'>private</span> Cookie<span class='opr'>[</span><span class='opr'>]</span>        cookies;

        <span class='com'>/**********************************************************************

                Construct a cookie stack with the specified initial extent.
                The stack will grow as necessary over time.

        **********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span><span class='kw4'>int</span> size<span class='opr'>)</span>
        <span class='opr'>{</span>
                cookies <span class='opr'>=</span> <span class='kw2'>new</span> Cookie<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span>;
                resize <span class='opr'>(</span>cookies, size<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/**********************************************************************

                Pop the stack all the way to zero

        **********************************************************************/</span>

        <span class='kw4'>final</span> <span class='kw4'>void</span> reset <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                depth <span class='opr'>=</span> <span class='nbr'>0</span>;
        <span class='opr'>}</span>

        <span class='com'>/**********************************************************************

                Return a fresh cookie from the stack

        **********************************************************************/</span>

        <span class='kw4'>final</span> Cookie push <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>if</span> <span class='opr'>(</span>depth <span class='opr'>=</span><span class='opr'>=</span> cookies.length<span class='opr'>)</span>
                    resize <span class='opr'>(</span>cookies, depth <span class='opr'>*</span> <span class='nbr'>2</span><span class='opr'>)</span>;
                <span class='kw1'>return</span> cookies <span class='opr'>[</span>depth<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
        <span class='opr'>}</span>
        
        <span class='com'>/**********************************************************************

                Resize the stack such that is has more room.

        **********************************************************************/</span>

        <span class='kw4'>private</span> <span class='kw4'>final</span> <span class='kw4'>static</span> <span class='kw4'>void</span> resize <span class='opr'>(</span><span class='kw2'>inout</span> Cookie<span class='opr'>[</span><span class='opr'>]</span> cookies, <span class='kw4'>int</span> size<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw4'>int</span> i <span class='opr'>=</span> cookies.length;
                
                <span class='kw1'>for</span> <span class='opr'>(</span>cookies.length<span class='opr'>=</span>size; i <span class='opr'>&lt;</span> cookies.length; <span class='opr'>+</span><span class='opr'>+</span>i<span class='opr'>)</span>
                     cookies<span class='opr'>[</span>i<span class='opr'>]</span> <span class='opr'>=</span> <span class='kw2'>new</span> Cookie<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/**********************************************************************

                Iterate over all cookies in stack

        **********************************************************************/</span>

        <span class='kw4'>int</span> opApply <span class='opr'>(</span><span class='kw4'>int</span> <span class='kw2'>delegate</span><span class='opr'>(</span><span class='kw2'>inout</span> Cookie<span class='opr'>)</span> dg<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw4'>int</span> result <span class='opr'>=</span> <span class='nbr'>0</span>;

                <span class='kw1'>for</span> <span class='opr'>(</span><span class='kw4'>int</span> i<span class='opr'>=</span><span class='nbr'>0</span>; i <span class='opr'>&lt;</span> depth; <span class='opr'>+</span><span class='opr'>+</span>i<span class='opr'>)</span>
                     <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>result <span class='opr'>=</span> dg <span class='opr'>(</span>cookies<span class='opr'>[</span>i<span class='opr'>]</span><span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                          <span class='kw1'>break</span>;
                <span class='kw1'>return</span> result;
        <span class='opr'>}</span>
<span class='opr'>}</span>



<span class='com'>/*******************************************************************************

        This is the support point for server-side cookies. It wraps a
        CookieStack together with a set of HttpHeaders, along with the
        appropriate cookie parser. One would do something very similar
        for client side cookie parsing also.

*******************************************************************************/</span>

<span class='kw4'>class</span> HttpCookies : IWritable
<span class='opr'>{</span>
        <span class='kw4'>private</span> <span class='kw4'>bool</span>                    parsed;
        <span class='kw4'>private</span> CookieStack             stack;
        <span class='kw4'>private</span> CookieParser            parser;
        <span class='kw4'>private</span> HttpHeaders             headers;

        <span class='com'>/**********************************************************************

                Construct cookie wrapper with the provided headers.

        **********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span>HttpHeaders headers<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.headers <span class='opr'>=</span> headers;

                <span class='com'>// create a stack for parsed cookies</span>
                stack <span class='opr'>=</span> <span class='kw2'>new</span> CookieStack <span class='opr'>(</span><span class='nbr'>10</span><span class='opr'>)</span>;

                <span class='com'>// create a parser</span>
                parser <span class='opr'>=</span> <span class='kw2'>new</span> CookieParser <span class='opr'>(</span>stack<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/**********************************************************************

                Output each of the cookies parsed to the provided IWriter.

        **********************************************************************/</span>

        <span class='kw4'>void</span> write <span class='opr'>(</span>IWriter writer<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>foreach</span> <span class='opr'>(</span>Cookie cookie; parse<span class='opr'>)</span>
                         writer.put <span class='opr'>(</span>cookie<span class='opr'>)</span>.cr<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/**********************************************************************

                Reset these cookies for another parse

        **********************************************************************/</span>

        <span class='kw4'>void</span> reset <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                stack.reset<span class='opr'>(</span><span class='opr'>)</span>;
                parsed <span class='opr'>=</span> <span class='kw2'>false</span>;
        <span class='opr'>}</span>

        <span class='com'>/**********************************************************************

                Parse all cookies from our HttpHeaders, pushing each onto
                the CookieStack as we go.

        **********************************************************************/</span>

        CookieStack parse <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>if</span> <span class='opr'>(</span>! parsed<span class='opr'>)</span>
                   <span class='opr'>{</span>
                   parsed <span class='opr'>=</span> <span class='kw2'>true</span>;

                   <span class='kw1'>foreach</span> <span class='opr'>(</span>HeaderElement header; headers<span class='opr'>)</span>
                            <span class='kw1'>if</span> <span class='opr'>(</span>header.name.value <span class='opr'>=</span><span class='opr'>=</span> HttpHeader.Cookie.value<span class='opr'>)</span>
                                parser.parse <span class='opr'>(</span>header.value<span class='opr'>)</span>;
                   <span class='opr'>}</span>
                <span class='kw1'>return</span> stack;
        <span class='opr'>}</span>
<span class='opr'>}</span>



<span class='com'>/*******************************************************************************

        Handles a set of output cookies by writing them into the list of
        output headers.

*******************************************************************************/</span>

<span class='kw4'>class</span> HttpMutableCookies
<span class='opr'>{</span>
        <span class='kw4'>private</span> HttpWriter              writer;
        <span class='kw4'>private</span> HttpMutableHeaders      headers;

        <span class='com'>/**********************************************************************

                Construct an output cookie wrapper upon the provided 
                output headers. Each cookie added is converted to an
                addition to those headers.

        **********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span>HttpMutableHeaders headers<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>this</span>.headers <span class='opr'>=</span> headers;
                writer <span class='opr'>=</span> <span class='kw2'>new</span> HttpWriter <span class='opr'>(</span>headers.getOutputBuffer<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/**********************************************************************

                Add a cookie to our output headers.

        **********************************************************************/</span>

        <span class='kw4'>void</span> add <span class='opr'>(</span>Cookie cookie<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='com'>// nested function to actually perform the output</span>
                <span class='kw4'>void</span> writeCookie <span class='opr'>(</span>IBuffer buf<span class='opr'>)</span>
                <span class='opr'>{</span>
                        cookie.write <span class='opr'>(</span>writer<span class='opr'>)</span>;
                <span class='opr'>}</span>

                <span class='com'>// add the cookie header via our callback</span>
                headers.add <span class='opr'>(</span>HttpHeader.SetCookie, <span class='opr'>&amp;</span>writeCookie<span class='opr'>)</span>;        
        <span class='opr'>}</span>
<span class='opr'>}</span>



<span class='com'>/*******************************************************************************

        Server-side cookie parser. See RFC 2109 for details.

*******************************************************************************/</span>

<span class='kw4'>class</span> CookieParser : IteratorT!<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>)</span>
<span class='opr'>{</span>
        <span class='kw4'>private</span> <span class='kw4'>enum</span> State <span class='opr'>{</span>Begin, LValue, Equals, RValue, Token, SQuote, DQuote<span class='opr'>}</span>;

        <span class='kw4'>private</span> CookieStack stack;

        <span class='com'>/***********************************************************************

        ***********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span>CookieStack stack<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span> <span class='opr'>(</span><span class='opr'>)</span>;
                <span class='kw2'>this</span>.stack <span class='opr'>=</span> stack;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************

                Callback for iterator.next(). We scan for name-value
                pairs, populating Cookie instances along the way.

        ***********************************************************************/</span>

        <span class='kw4'>protected</span> <span class='kw4'>uint</span> scan <span class='opr'>(</span><span class='kw4'>void</span><span class='opr'>[</span><span class='opr'>]</span> data<span class='opr'>)</span>
        <span class='opr'>{</span>      
                <span class='kw4'>char</span>    c;
                <span class='kw4'>int</span>     mark,
                        vrsn;
                <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span>  name,
                        token;
                Cookie  cookie;

                State   state <span class='opr'>=</span> State.Begin;
                <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span>  content <span class='opr'>=</span> <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>)</span> data;

                <span class='com'>/***************************************************************

                        Found a value; set that also

                ***************************************************************/</span>

                <span class='kw4'>void</span> setValue <span class='opr'>(</span><span class='kw4'>int</span> i<span class='opr'>)</span>
                <span class='opr'>{</span>   
                        token <span class='opr'>=</span> content <span class='opr'>[</span>mark<span class='opr'>..</span>i<span class='opr'>]</span>;
                        <span class='com'>//Print (&quot;::name '%.*s'\n&quot;, name);</span>
                        <span class='com'>//Print (&quot;::value '%.*s'\n&quot;, token);</span>

                        <span class='kw1'>if</span> <span class='opr'>(</span>name<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span> <span class='opr'>!=</span> <span class='str'>'$'</span><span class='opr'>)</span>
                           <span class='opr'>{</span>
                           cookie <span class='opr'>=</span> stack.push<span class='opr'>(</span><span class='opr'>)</span>;
                           cookie.setName <span class='opr'>(</span>name<span class='opr'>)</span>;
                           cookie.setValue <span class='opr'>(</span>token<span class='opr'>)</span>;
                           cookie.setVersion <span class='opr'>(</span>vrsn<span class='opr'>)</span>;
                           <span class='opr'>}</span>
                        <span class='kw1'>else</span>
                           <span class='kw1'>switch</span> <span class='opr'>(</span>toLower <span class='opr'>(</span>name<span class='opr'>)</span><span class='opr'>)</span>
                                  <span class='opr'>{</span>
                                  <span class='kw1'>case</span> <span class='str'>&quot;$path&quot;</span>:
                                        <span class='kw1'>if</span> <span class='opr'>(</span>cookie<span class='opr'>)</span>
                                            cookie.setPath <span class='opr'>(</span>token<span class='opr'>)</span>; 
                                        <span class='kw1'>break</span>;

                                  <span class='kw1'>case</span> <span class='str'>&quot;$domain&quot;</span>:
                                        <span class='kw1'>if</span> <span class='opr'>(</span>cookie<span class='opr'>)</span>
                                            cookie.setDomain <span class='opr'>(</span>token<span class='opr'>)</span>; 
                                        <span class='kw1'>break</span>;

                                  <span class='kw1'>case</span> <span class='str'>&quot;$version&quot;</span>:
                                        vrsn <span class='opr'>=</span> <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>int</span><span class='opr'>)</span> Integer.parse <span class='opr'>(</span>token<span class='opr'>)</span>; 
                                        <span class='kw1'>break</span>;

                                  <span class='kw2'>default</span>:
                                       <span class='kw1'>break</span>;
                                  <span class='opr'>}</span>
                        state <span class='opr'>=</span> State.Begin;
                <span class='opr'>}</span>

                <span class='com'>/***************************************************************

                        Scan content looking for cookie fields

                ***************************************************************/</span>

                <span class='kw1'>for</span> <span class='opr'>(</span><span class='kw4'>int</span> i; i <span class='opr'>&lt;</span> content.length; <span class='opr'>+</span><span class='opr'>+</span>i<span class='opr'>)</span>
                    <span class='opr'>{</span>
                    c <span class='opr'>=</span> content <span class='opr'>[</span>i<span class='opr'>]</span>;
                    <span class='kw1'>switch</span> <span class='opr'>(</span>state<span class='opr'>)</span>
                           <span class='opr'>{</span>
                           <span class='com'>// look for an lValue</span>
                           <span class='kw1'>case</span> State.Begin:
                                mark <span class='opr'>=</span> i;
                                <span class='kw1'>if</span> <span class='opr'>(</span>isalpha <span class='opr'>(</span>c<span class='opr'>)</span> || c <span class='kw2'>is</span> <span class='str'>'$'</span><span class='opr'>)</span>
                                    state <span class='opr'>=</span> State.LValue;
                                <span class='kw1'>continue</span>;

                           <span class='com'>// scan until we have all lValue chars</span>
                           <span class='kw1'>case</span> State.LValue:
                                <span class='kw1'>if</span> <span class='opr'>(</span>! isalnum <span class='opr'>(</span>c<span class='opr'>)</span><span class='opr'>)</span>
                                   <span class='opr'>{</span>
                                   state <span class='opr'>=</span> State.Equals;
                                   name <span class='opr'>=</span> content <span class='opr'>[</span>mark<span class='opr'>..</span>i<span class='opr'>]</span>;
                                   <span class='opr'>-</span><span class='opr'>-</span>i;
                                   <span class='opr'>}</span>
                                <span class='kw1'>continue</span>;

                           <span class='com'>// should now have either a '=', ';', or ','</span>
                           <span class='kw1'>case</span> State.Equals:
                                <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='kw2'>is</span> <span class='str'>'='</span><span class='opr'>)</span>
                                    state <span class='opr'>=</span> State.RValue;
                                <span class='kw1'>else</span>
                                   <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='kw2'>is</span> <span class='str'>','</span> || c <span class='kw2'>is</span> <span class='str'>';'</span><span class='opr'>)</span>
                                       <span class='com'>// get next NVPair</span>
                                       state <span class='opr'>=</span> State.Begin;
                                <span class='kw1'>continue</span>;

                           <span class='com'>// look for a quoted token, or a plain one</span>
                           <span class='kw1'>case</span> State.RValue:
                                mark <span class='opr'>=</span> i;
                                <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='kw2'>is</span> <span class='str'>'&#039;'</span><span class='opr'>)</span>
                                    state <span class='opr'>=</span> State.SQuote;
                                <span class='kw1'>else</span>
                                   <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='kw2'>is</span> <span class='str'>'&quot;'</span><span class='opr'>)</span>
                                       state <span class='opr'>=</span> State.DQuote;
                                   <span class='kw1'>else</span>
                                      <span class='kw1'>if</span> <span class='opr'>(</span>isalpha <span class='opr'>(</span>c<span class='opr'>)</span><span class='opr'>)</span>
                                          state <span class='opr'>=</span> State.Token;
                                <span class='kw1'>continue</span>;

                           <span class='com'>// scan for all plain token chars</span>
                           <span class='kw1'>case</span> State.Token:
                                <span class='kw1'>if</span> <span class='opr'>(</span>! isalnum <span class='opr'>(</span>c<span class='opr'>)</span><span class='opr'>)</span>
                                   <span class='opr'>{</span>
                                   setValue <span class='opr'>(</span>i<span class='opr'>)</span>;
                                   <span class='opr'>-</span><span class='opr'>-</span>i;
                                   <span class='opr'>}</span>
                                <span class='kw1'>continue</span>;

                           <span class='com'>// scan until the next '</span>
                           <span class='kw1'>case</span> State.SQuote:
                                <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='kw2'>is</span> <span class='str'>'&#039;'</span><span class='opr'>)</span>
                                    <span class='opr'>+</span><span class='opr'>+</span>mark, setValue <span class='opr'>(</span>i<span class='opr'>)</span>;
                                <span class='kw1'>continue</span>;

                           <span class='com'>// scan until the next &quot;</span>
                           <span class='kw1'>case</span> State.DQuote:
                                <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='kw2'>is</span> <span class='str'>'&quot;'</span><span class='opr'>)</span>
                                    <span class='opr'>+</span><span class='opr'>+</span>mark, setValue <span class='opr'>(</span>i<span class='opr'>)</span>;
                                <span class='kw1'>continue</span>;

                           <span class='kw2'>default</span>:
                                <span class='kw1'>continue</span>;
                           <span class='opr'>}</span>
                    <span class='opr'>}</span>

                <span class='com'>// we ran out of content; patch partial cookie values </span>
                <span class='kw1'>if</span> <span class='opr'>(</span>state <span class='kw2'>is</span> State.Token<span class='opr'>)</span>
                    setValue <span class='opr'>(</span>content.length<span class='opr'>)</span>;

                <span class='com'>// go home</span>
                <span class='kw1'>return</span> IConduit.Eof;
        <span class='opr'>}</span>
                                
        <span class='com'>/***********************************************************************
        
                Locate the next token from the provided buffer, and map a
                buffer reference into token. Returns true if a token was 
                located, false otherwise. 

                Note that the buffer content is not duplicated. Instead, a
                slice of the buffer is referenced by the token. You can use
                Token.clone() or Token.toString().dup() to copy content per
                your application needs.

                Note also that there may still be one token left in a buffer 
                that was not terminated correctly (as in eof conditions). In 
                such cases, tokens are mapped onto remaining content and the 
                buffer will have no more readable content.

        ***********************************************************************/</span>

        <span class='kw4'>bool</span> parse <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> header<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span>.set <span class='opr'>(</span>header<span class='opr'>)</span>;
                <span class='kw1'>return</span> next <span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/**********************************************************************

                in-place conversion to lowercase 

        **********************************************************************/</span>

        <span class='kw4'>final</span> <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> toLower <span class='opr'>(</span><span class='kw2'>inout</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> src<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>foreach</span> <span class='opr'>(</span><span class='kw4'>int</span> i, <span class='kw4'>char</span> c; src<span class='opr'>)</span>
                         <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='str'>'A'</span> &amp;&amp; c <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='str'>'Z'</span><span class='opr'>)</span>
                             src<span class='opr'>[</span>i<span class='opr'>]</span> <span class='opr'>=</span> c <span class='opr'>+</span> <span class='opr'>(</span><span class='str'>'a'</span> <span class='opr'>-</span> <span class='str'>'A'</span><span class='opr'>)</span>;
                <span class='kw1'>return</span> src;
        <span class='opr'>}</span>
<span class='opr'>}</span>
   
     
</pre></td></tr></table>	</body>
</html>
