<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<title>OS.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)
        
        version:        Initial release: November 2005
        
        author:         Kris

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.os.OS;

<span class='kw4'>version</span> <span class='opr'>(</span>Win32<span class='opr'>)</span>
         <span class='kw4'>public</span> <span class='kw2'>import</span> tango.os.windows.c.minwin; 

<span class='kw4'>version</span> <span class='opr'>(</span>linux<span class='opr'>)</span>
        <span class='opr'>{</span>
        <span class='kw4'>public</span> <span class='kw2'>import</span> tango.os.linux.c.linux;
        <span class='kw2'>alias</span> tango.os.linux.c.linux posix;
        <span class='opr'>}</span>

<span class='kw4'>version</span> <span class='opr'>(</span>darwin<span class='opr'>)</span>
        <span class='opr'>{</span>
        <span class='kw4'>public</span> <span class='kw2'>import</span> tango.os.darwin.c.darwin;
        <span class='kw2'>alias</span> tango.os.darwin.c.darwin posix;
        <span class='opr'>}</span>


<span class='com'>/*******************************************************************************

        Stuff for sysError(), kindly provided by Regan Heath. 

*******************************************************************************/</span>

<span class='kw4'>version</span> <span class='opr'>(</span>Win32<span class='opr'>)</span>
        <span class='opr'>{</span>
        <span class='kw4'>private</span> <span class='kw4'>const</span> FORMAT_MESSAGE_ALLOCATE_BUFFER <span class='opr'>=</span> <span class='nbr'>0</span>x00000100;
        <span class='kw4'>private</span> <span class='kw4'>const</span> FORMAT_MESSAGE_IGNORE_INSERTS  <span class='opr'>=</span> <span class='nbr'>0</span>x00000200;
        <span class='kw4'>private</span> <span class='kw4'>const</span> FORMAT_MESSAGE_FROM_STRING     <span class='opr'>=</span> <span class='nbr'>0</span>x00000400;
        <span class='kw4'>private</span> <span class='kw4'>const</span> FORMAT_MESSAGE_FROM_HMODULE    <span class='opr'>=</span> <span class='nbr'>0</span>x00000800;
        <span class='kw4'>private</span> <span class='kw4'>const</span> FORMAT_MESSAGE_FROM_SYSTEM     <span class='opr'>=</span> <span class='nbr'>0</span>x00001000;
        <span class='kw4'>private</span> <span class='kw4'>const</span> FORMAT_MESSAGE_ARGUMENT_ARRAY  <span class='opr'>=</span> <span class='nbr'>0</span>x00002000;
        <span class='kw4'>private</span> <span class='kw4'>const</span> FORMAT_MESSAGE_MAX_WIDTH_MASK  <span class='opr'>=</span> <span class='nbr'>0</span>x000000FF;

        <span class='kw4'>private</span> DWORD MAKELANGID<span class='opr'>(</span>WORD p, WORD s<span class='opr'>)</span>  <span class='opr'>{</span> <span class='kw1'>return</span> <span class='opr'>(</span><span class='opr'>(</span><span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span>WORD<span class='opr'>)</span>s<span class='opr'>)</span> <span class='opr'>&lt;</span><span class='opr'>&lt;</span> <span class='nbr'>10</span><span class='opr'>)</span> | <span class='kw2'>cast</span><span class='opr'>(</span>WORD<span class='opr'>)</span>p<span class='opr'>)</span>; <span class='opr'>}</span>

        <span class='kw4'>private</span> <span class='kw2'>alias</span> HGLOBAL HLOCAL;

        <span class='kw4'>private</span> <span class='kw4'>const</span> LANG_NEUTRAL <span class='opr'>=</span> <span class='nbr'>0</span>x00;
        <span class='kw4'>private</span> <span class='kw4'>const</span> SUBLANG_DEFAULT <span class='opr'>=</span> <span class='nbr'>0</span>x01;

        <span class='kw2'>extern</span> <span class='opr'>(</span>Windows<span class='opr'>)</span> 
               <span class='opr'>{</span>
               DWORD FormatMessageA <span class='opr'>(</span>DWORD dwFlags,
                                     LPCVOID lpSource,
                                     DWORD dwMessageId,
                                     DWORD dwLanguageId,
                                     LPTSTR lpBuffer,
                                     DWORD nSize,
                                     LPCVOID args
                                     <span class='opr'>)</span>;

               HLOCAL LocalFree<span class='opr'>(</span>HLOCAL hMem<span class='opr'>)</span>;
               <span class='opr'>}</span>
        <span class='opr'>}</span>
<span class='kw1'>else</span>
<span class='kw4'>version</span> <span class='opr'>(</span>Posix<span class='opr'>)</span>
        <span class='opr'>{</span>
        <span class='kw4'>private</span> <span class='kw2'>import</span> tango.stdc.errno;

        <span class='kw2'>extern</span> <span class='opr'>(</span>C<span class='opr'>)</span> <span class='kw4'>char</span> <span class='opr'>*</span>strerror <span class='opr'>(</span><span class='kw4'>int</span><span class='opr'>)</span>;
        <span class='kw2'>extern</span> <span class='opr'>(</span>C<span class='opr'>)</span> <span class='kw4'>int</span> strlen <span class='opr'>(</span><span class='kw4'>char</span> <span class='opr'>*</span><span class='opr'>)</span>;
        <span class='opr'>}</span>
<span class='kw1'>else</span>
   <span class='kw4'>static</span> <span class='kw2'>assert</span><span class='opr'>(</span><span class='nbr'>0</span><span class='opr'>)</span>;

<span class='com'>/*******************************************************************************

        Some system-specific functionality that doesn't belong anywhere 
        else. This needs some further thought and refinement.

*******************************************************************************/</span>

<span class='kw4'>struct</span> OS
<span class='opr'>{</span>       
        <span class='com'>/***********************************************************************
        
        ***********************************************************************/</span>

        <span class='kw4'>final</span> <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> error <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw4'>version</span> <span class='opr'>(</span>Win32<span class='opr'>)</span>
                         <span class='kw1'>return</span> error <span class='opr'>(</span>GetLastError<span class='opr'>)</span>;
                     <span class='kw1'>else</span>
                        <span class='kw1'>return</span> error <span class='opr'>(</span>errno<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
        ***********************************************************************/</span>

        <span class='kw4'>final</span> <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> error <span class='opr'>(</span><span class='kw4'>uint</span> errcode<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> text;

                <span class='kw4'>version</span> <span class='opr'>(</span>Win32<span class='opr'>)</span>
                        <span class='opr'>{</span>
                        DWORD  r;
                        LPVOID lpMsgBuf;                        

                        r <span class='opr'>=</span> FormatMessageA <span class='opr'>(</span> 
                                FORMAT_MESSAGE_ALLOCATE_BUFFER | 
                                FORMAT_MESSAGE_FROM_SYSTEM | 
                                FORMAT_MESSAGE_IGNORE_INSERTS,
                                <span class='kw2'>null</span>,
                                errcode,
                                MAKELANGID<span class='opr'>(</span>LANG_NEUTRAL, SUBLANG_DEFAULT<span class='opr'>)</span>, <span class='com'>// Default language</span>
                                <span class='kw2'>cast</span><span class='opr'>(</span>LPTSTR<span class='opr'>)</span><span class='opr'>&amp;</span>lpMsgBuf,
                                <span class='nbr'>0</span>,
                                <span class='kw2'>null</span><span class='opr'>)</span>;

                        <span class='com'>/* Remove \r\n from error string */</span>
                        <span class='kw1'>if</span> <span class='opr'>(</span>r <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>2</span><span class='opr'>)</span> r<span class='opr'>-=</span> <span class='nbr'>2</span>;
                        text <span class='opr'>=</span> <span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>char</span> <span class='opr'>*</span><span class='opr'>)</span>lpMsgBuf<span class='opr'>)</span><span class='opr'>[</span><span class='nbr'>0.</span>.r<span class='opr'>]</span>.dup;
                        LocalFree<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span>HLOCAL<span class='opr'>)</span>lpMsgBuf<span class='opr'>)</span>;
                        <span class='opr'>}</span>
                     <span class='kw1'>else</span>
                        <span class='opr'>{</span>
                        <span class='kw4'>uint</span>  r;
                        <span class='kw4'>char</span><span class='opr'>*</span> pemsg;

                        pemsg <span class='opr'>=</span> strerror<span class='opr'>(</span>errcode<span class='opr'>)</span>;
                        r <span class='opr'>=</span> strlen<span class='opr'>(</span>pemsg<span class='opr'>)</span>;

                        <span class='com'>/* Remove \r\n from error string */</span>
                        <span class='kw1'>if</span> <span class='opr'>(</span>pemsg<span class='opr'>[</span>r<span class='opr'>-</span><span class='nbr'>1</span><span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'\n'</span><span class='opr'>)</span> r<span class='opr'>-</span><span class='opr'>-</span>;
                        <span class='kw1'>if</span> <span class='opr'>(</span>pemsg<span class='opr'>[</span>r<span class='opr'>-</span><span class='nbr'>1</span><span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'\r'</span><span class='opr'>)</span> r<span class='opr'>-</span><span class='opr'>-</span>;
                        text <span class='opr'>=</span> pemsg<span class='opr'>[</span><span class='nbr'>0.</span>.r<span class='opr'>]</span>.dup;
                        <span class='opr'>}</span>
                
                <span class='kw1'>return</span> text;
        <span class='opr'>}</span>
<span class='opr'>}</span>


</pre></td></tr></table>	</body>
</html>
