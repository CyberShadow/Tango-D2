<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="../../style.css" type="text/css" />
		<title>net/ftp/telnet.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
</pre></td><td id='code'><pre><span class='kw2'>module</span> tango.net.ftp.telnet;

<span class='com'>/// Utilities for telnet-based connections.</span>
<span class='com'>///</span>
<span class='com'>/// Params:</span>
<span class='com'>///    TelnetException =     the type for exceptions thrown</span>
<span class='com'>///    socket =              the connected socket</span>
<span class='com'>///    timeout =             the timeout for socket communication</span>
<span class='kw4'>template</span> TelnetUtilities<span class='opr'>(</span>TelnetException<span class='opr'>)</span>
<span class='opr'>{</span>
    <span class='com'>/// Send a line over the socket.</span>
    <span class='com'>///</span>
    <span class='com'>/// Params:</span>
    <span class='com'>///    buf =             the bytes to send</span>
    <span class='kw4'>protected</span> <span class='kw4'>void</span> socket_sendline<span class='opr'>(</span><span class='kw4'>void</span><span class='opr'>[</span><span class='opr'>]</span> buf<span class='opr'>)</span>
    <span class='opr'>{</span>
        <span class='kw2'>this</span>.socket_send<span class='opr'>(</span>buf<span class='opr'>)</span>;
        <span class='kw2'>this</span>.socket_send<span class='opr'>(</span><span class='str'>&quot;\r\n&quot;</span><span class='opr'>)</span>;
    <span class='opr'>}</span>

    <span class='com'>/// Send data over the socket.</span>
    <span class='com'>///</span>
    <span class='com'>/// Params:</span>
    <span class='com'>///    buf =             the bytes to send</span>
    <span class='kw4'>protected</span> <span class='kw4'>void</span> socket_send<span class='opr'>(</span><span class='kw4'>void</span><span class='opr'>[</span><span class='opr'>]</span> buf<span class='opr'>)</span>
    <span class='kw2'>in</span>
    <span class='opr'>{</span>
        <span class='kw2'>assert</span> <span class='opr'>(</span>buf.length <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span>;
    <span class='opr'>}</span>
    <span class='kw2'>body</span>
    <span class='opr'>{</span>
        <span class='com'>// At end_time, we bail.</span>
        d_time end_time <span class='opr'>=</span> getUTCtime<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>+</span> <span class='kw2'>cast</span><span class='opr'>(</span>d_time<span class='opr'>)</span> <span class='opr'>(</span><span class='kw2'>this</span>.timeout <span class='opr'>*</span> TicksPerSecond<span class='opr'>)</span>;

        <span class='com'>// Set up a SocketSet so we can use select() - it's pretty efficient.</span>
        SocketSet set <span class='opr'>=</span> <span class='kw2'>new</span> SocketSet<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw2'>scope</span> <span class='opr'>(</span>exit<span class='opr'>)</span>
            <span class='kw2'>delete</span> set;

        <span class='kw4'>size_t</span> pos <span class='opr'>=</span> <span class='nbr'>0</span>;
        <span class='kw1'>while</span> <span class='opr'>(</span>getUTCtime<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>&lt;</span> end_time<span class='opr'>)</span>
        <span class='opr'>{</span>
            set.reset<span class='opr'>(</span><span class='opr'>)</span>;
            set.add<span class='opr'>(</span><span class='kw2'>this</span>.socket<span class='opr'>)</span>;

            <span class='com'>// Can we write yet, can we write yet?</span>
            <span class='kw4'>int</span> code <span class='opr'>=</span> Socket.select<span class='opr'>(</span><span class='kw2'>null</span>, set, <span class='kw2'>null</span>, <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>int</span><span class='opr'>)</span> <span class='opr'>(</span><span class='kw2'>this</span>.timeout <span class='opr'>*</span> <span class='nbr'>1_000_000</span><span class='opr'>)</span><span class='opr'>)</span>;
            <span class='kw1'>if</span> <span class='opr'>(</span>code <span class='opr'>=</span><span class='opr'>=</span> <span class='opr'>-</span><span class='nbr'>1</span> || code <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                <span class='kw1'>break</span>;

            <span class='com'>// Send it (or as much as possible!)</span>
            <span class='kw4'>int</span> delta <span class='opr'>=</span> <span class='kw2'>this</span>.socket.send<span class='opr'>(</span>buf<span class='opr'>[</span>pos <span class='opr'>..</span> buf.length<span class='opr'>]</span><span class='opr'>)</span>;
            <span class='kw1'>if</span> <span class='opr'>(</span>delta <span class='opr'>=</span><span class='opr'>=</span> <span class='kw2'>this</span>.socket.ERROR<span class='opr'>)</span>
                <span class='kw1'>break</span>;

            pos <span class='opr'>+=</span> delta;
            <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>&gt;</span><span class='opr'>=</span> buf.length<span class='opr'>)</span>
                <span class='kw1'>break</span>;
        <span class='opr'>}</span>

        <span class='com'>// If we didn't send everything, we're dead in the water.</span>
        <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>!=</span> buf.length<span class='opr'>)</span>
            <span class='kw2'>throw</span> <span class='kw2'>new</span> TelnetException<span class='opr'>(</span><span class='str'>&quot;CLIENT: Timeout when sending command&quot;</span><span class='opr'>)</span>;
    <span class='opr'>}</span>

    <span class='com'>/// Read a CRLF terminated line from the socket.</span>
    <span class='com'>///</span>
    <span class='com'>/// Returns:             the line read</span>
    <span class='kw4'>protected</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> socket_readline<span class='opr'>(</span><span class='opr'>)</span>
    <span class='opr'>{</span>
        <span class='com'>// Figure, first, how long we're allowed to take.</span>
        d_time end_time <span class='opr'>=</span> getUTCtime<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>+</span> <span class='kw2'>cast</span><span class='opr'>(</span>d_time<span class='opr'>)</span> <span class='opr'>(</span><span class='kw2'>this</span>.timeout <span class='opr'>*</span> TicksPerSecond<span class='opr'>)</span>;

        <span class='com'>// An overall buffer and a one-char buffer.</span>
        <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> buffer;
        <span class='kw4'>char</span><span class='opr'>[</span><span class='nbr'>1</span><span class='opr'>]</span> buf;
        <span class='kw4'>size_t</span> buffer_pos <span class='opr'>=</span> <span class='nbr'>0</span>;

        <span class='com'>// Push a byte onto the buffer.</span>
        <span class='kw4'>void</span> push_byte<span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
            <span class='com'>// Lines aren't usually that long.  Allocate in blocks of 16 bytes.</span>
            <span class='kw1'>if</span> <span class='opr'>(</span>buffer.length <span class='opr'>&lt;</span><span class='opr'>=</span> buffer_pos<span class='opr'>)</span>
                buffer.length <span class='opr'>=</span> buffer.length <span class='opr'>+</span> <span class='nbr'>16</span>;

            buffer<span class='opr'>[</span>buffer_pos<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span> <span class='opr'>=</span> buf<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span>;
        <span class='opr'>}</span>

        <span class='com'>// Get the resultant buffer.</span>
        <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> get_buffer<span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
            <span class='kw1'>return</span> buffer<span class='opr'>[</span><span class='nbr'>0</span> <span class='opr'>..</span> buffer_pos<span class='opr'>]</span>;
        <span class='opr'>}</span>

        <span class='com'>// Now the socket set for selecting purposes.</span>
        SocketSet set <span class='opr'>=</span> <span class='kw2'>new</span> SocketSet<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw2'>scope</span> <span class='opr'>(</span>exit<span class='opr'>)</span>
            <span class='kw2'>delete</span> set;

        <span class='kw1'>while</span> <span class='opr'>(</span>getUTCtime<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>&lt;</span> end_time<span class='opr'>)</span>
        <span class='opr'>{</span>
            set.reset<span class='opr'>(</span><span class='opr'>)</span>;
            set.add<span class='opr'>(</span><span class='kw2'>this</span>.socket<span class='opr'>)</span>;

            <span class='com'>// Try to read from the socket.</span>
            <span class='kw4'>int</span> code <span class='opr'>=</span> Socket.select<span class='opr'>(</span>set, <span class='kw2'>null</span>, <span class='kw2'>null</span>, <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>int</span><span class='opr'>)</span> <span class='opr'>(</span><span class='kw2'>this</span>.timeout <span class='opr'>*</span> <span class='nbr'>1_000_000</span><span class='opr'>)</span><span class='opr'>)</span>;
            <span class='kw1'>if</span> <span class='opr'>(</span>code <span class='opr'>=</span><span class='opr'>=</span> <span class='opr'>-</span><span class='nbr'>1</span> || code <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                <span class='kw1'>break</span>;

            <span class='com'>// Okay, now we're ready.  Read in the measly byte.</span>
            <span class='kw4'>int</span> delta <span class='opr'>=</span> <span class='kw2'>this</span>.socket.receive<span class='opr'>(</span>buf<span class='opr'>)</span>;
            <span class='kw1'>if</span> <span class='opr'>(</span>delta <span class='opr'>!=</span> <span class='nbr'>1</span><span class='opr'>)</span>
                <span class='kw1'>break</span>;

            <span class='kw1'>if</span> <span class='opr'>(</span>buf <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>&quot;\r&quot;</span><span class='opr'>)</span>
                <span class='kw1'>continue</span>;
            <span class='kw1'>else</span> <span class='kw1'>if</span> <span class='opr'>(</span>buf <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>&quot;\n&quot;</span><span class='opr'>)</span>
                <span class='kw1'>break</span>;

            push_byte<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='kw1'>return</span> get_buffer<span class='opr'>(</span><span class='opr'>)</span>;
    <span class='opr'>}</span>

    <span class='com'>/// Find a server which is listening on the specified port.</span>
    <span class='com'>///</span>
    <span class='com'>/// Params:</span>
    <span class='com'>///    hostname =        the hostname to lookup and connect to</span>
    <span class='com'>///    port =            the port to connect on</span>
    <span class='kw4'>protected</span> Socket find_available_server<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> hostname, <span class='kw4'>int</span> port<span class='opr'>)</span>
    <span class='opr'>{</span>
        <span class='com'>// First we need to get a list of IP addresses.</span>
        <span class='kw4'>auto</span> host <span class='opr'>=</span> <span class='kw2'>new</span> InternetHost<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw2'>scope</span> <span class='opr'>(</span>exit<span class='opr'>)</span>
            <span class='kw2'>delete</span> host;

        <span class='com'>// Try to resolve the actual address for this hostname.</span>
        host.getHostByName<span class='opr'>(</span>hostname<span class='opr'>)</span>;
        <span class='kw2'>scope</span> <span class='opr'>(</span>exit<span class='opr'>)</span>
            <span class='kw2'>delete</span> host.addrList;

        <span class='com'>// None were found... darn.</span>
        <span class='kw1'>if</span> <span class='opr'>(</span>host.addrList.length <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
            <span class='kw2'>throw</span> <span class='kw2'>new</span> AddressException<span class='opr'>(</span><span class='str'>&quot;Unable to resolve host '&quot;</span> <span class='opr'>~</span> hostname <span class='opr'>~</span> <span class='str'>&quot;'&quot;</span><span class='opr'>)</span>;

        <span class='com'>// Get all the sockets ready (or just one if there's just one address.)</span>
        Socket<span class='opr'>[</span><span class='opr'>]</span> sockets <span class='opr'>=</span> <span class='kw2'>new</span> Socket<span class='opr'>[</span>host.addrList.length<span class='opr'>]</span>;
        <span class='kw2'>scope</span> <span class='opr'>(</span>exit<span class='opr'>)</span>
            <span class='kw2'>delete</span> sockets;

        <span class='com'>// And now just connect to all of them.</span>
        <span class='kw1'>for</span> <span class='opr'>(</span><span class='kw4'>int</span> i <span class='opr'>=</span> <span class='nbr'>0</span>; i <span class='opr'>&lt;</span> host.addrList.length; i<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>)</span>
        <span class='opr'>{</span>
            sockets<span class='opr'>[</span>i<span class='opr'>]</span> <span class='opr'>=</span> <span class='kw2'>new</span> TcpSocket<span class='opr'>(</span>AddressFamily.INET<span class='opr'>)</span>;
            sockets<span class='opr'>[</span>i<span class='opr'>]</span>.blocking <span class='opr'>=</span> <span class='kw2'>false</span>;

            Address addr <span class='opr'>=</span> <span class='kw2'>new</span> InternetAddress<span class='opr'>(</span>host.addrList<span class='opr'>[</span>i<span class='opr'>]</span>, port<span class='opr'>)</span>;
            <span class='kw2'>scope</span> <span class='opr'>(</span>exit<span class='opr'>)</span>
                <span class='kw2'>delete</span> addr;

            <span class='com'>// Start trying to connect as soon as possible.</span>
            sockets<span class='opr'>[</span>i<span class='opr'>]</span>.connect<span class='opr'>(</span>addr<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>// Set up some stuff so we can select through the hosts.</span>
        SocketSet set <span class='opr'>=</span> <span class='kw2'>new</span> SocketSet<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw2'>this</span>.socket <span class='opr'>=</span> <span class='kw2'>null</span>;

        <span class='kw2'>scope</span> <span class='opr'>(</span>exit<span class='opr'>)</span>
            <span class='kw2'>delete</span> set;

        <span class='com'>// Wait until we find a good socket...</span>
        <span class='kw1'>while</span> <span class='opr'>(</span><span class='kw2'>this</span>.socket <span class='kw2'>is</span> <span class='kw2'>null</span><span class='opr'>)</span>
        <span class='opr'>{</span>
            set.reset<span class='opr'>(</span><span class='opr'>)</span>;
            <span class='kw1'>foreach</span> <span class='opr'>(</span>Socket s; sockets<span class='opr'>)</span>
                set.add<span class='opr'>(</span>s<span class='opr'>)</span>;

            <span class='com'>// Anyone available?</span>
            <span class='kw4'>int</span> code <span class='opr'>=</span> Socket.select<span class='opr'>(</span><span class='kw2'>null</span>, set, <span class='kw2'>null</span>, <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>int</span><span class='opr'>)</span> <span class='opr'>(</span><span class='kw2'>this</span>.timeout <span class='opr'>*</span> <span class='nbr'>1_000_000</span><span class='opr'>)</span><span class='opr'>)</span>;
            <span class='kw1'>if</span> <span class='opr'>(</span>code <span class='opr'>=</span><span class='opr'>=</span> <span class='opr'>-</span><span class='nbr'>1</span> || code <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                <span class='kw1'>break</span>;

            <span class='com'>// Now we have to check to find a good socket, and break out if we find one.</span>
            <span class='kw1'>foreach</span> <span class='opr'>(</span>Socket s; sockets<span class='opr'>)</span>
                <span class='kw1'>if</span> <span class='opr'>(</span>set.isSet<span class='opr'>(</span>s<span class='opr'>)</span><span class='opr'>)</span>
                <span class='opr'>{</span>
                    <span class='kw2'>this</span>.socket <span class='opr'>=</span> s;
                    <span class='kw1'>break</span>;
                <span class='opr'>}</span>
        <span class='opr'>}</span>

        <span class='com'>// Close the other sockets (or all on error.)</span>
        <span class='kw1'>foreach</span> <span class='opr'>(</span>Socket s; sockets<span class='opr'>)</span>
            <span class='kw1'>if</span> <span class='opr'>(</span>s !<span class='kw2'>is</span> <span class='kw2'>this</span>.socket<span class='opr'>)</span>
            <span class='opr'>{</span>
                s.shutdown<span class='opr'>(</span>SocketShutdown.BOTH<span class='opr'>)</span>;
                s.close<span class='opr'>(</span><span class='opr'>)</span>;

                <span class='kw2'>delete</span> s;
            <span class='opr'>}</span>

        <span class='com'>// No socket, no data.  Can't do anything about that.</span>
        <span class='kw1'>if</span> <span class='opr'>(</span><span class='kw2'>this</span>.socket <span class='kw2'>is</span> <span class='kw2'>null</span><span class='opr'>)</span>
            <span class='kw2'>throw</span> <span class='kw2'>new</span> TelnetException<span class='opr'>(</span><span class='str'>&quot;CLIENT: Unable to connect within the specified time limit (&quot;</span> <span class='opr'>~</span> std.string.toString<span class='opr'>(</span><span class='kw2'>this</span>.timeout <span class='opr'>*</span> <span class='nbr'>1_000</span><span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot; ms.)&quot;</span><span class='opr'>)</span>;

        <span class='com'>// Make it blocking again, because that's the norm.</span>
        <span class='kw2'>this</span>.socket.blocking <span class='opr'>=</span> <span class='kw2'>true</span>;

        <span class='kw1'>return</span> <span class='kw2'>this</span>.socket;
    <span class='opr'>}</span>
<span class='opr'>}</span>
</pre></td></tr></table>	</body>
</html>
