<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="../style.css" type="text/css" />
		<title>net/DatagramSocket.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)

        version:        Initial release: March 2004      
        
        author:         Kris

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.net.DatagramSocket;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.net.Socket,
                tango.io.Exception;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.io.model.IBuffer,
                tango.io.model.IConduit;

<span class='com'>/*******************************************************************************
        
        Wrapper around datagram style of sockets, to simplify the API a
        bit, and to tie them into the IBuffer construct.

        Note that when used with a SocketListener you must first bind the
        DatagramSocket to a local adapter. This can be done by binding it
        to an InternetAddress constructed with a port only (ADDR_ANY).

*******************************************************************************/</span>

<span class='kw4'>class</span> DatagramSocket : Socket, ISocketReader
<span class='opr'>{</span>
        <span class='com'>/***********************************************************************
        
                Create an internet datagram socket

        ***********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span> <span class='opr'>(</span>AddressFamily.INET, Type.DGRAM, Protocol.IP<span class='opr'>)</span>;                
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Read the available bytes from datagram into the given IBuffer.
                The 'from' address will be populated appropriately

        ***********************************************************************/</span>

        <span class='kw4'>uint</span> read <span class='opr'>(</span>IBuffer target, <span class='kw2'>inout</span> Address addr<span class='opr'>)</span>
        <span class='kw2'>in</span> <span class='opr'>{</span>
           <span class='kw2'>assert</span> <span class='opr'>(</span>target<span class='opr'>)</span>;
           <span class='opr'>}</span>
        <span class='kw2'>body</span>
        <span class='opr'>{</span>
                <span class='kw4'>uint</span> reader <span class='opr'>(</span><span class='kw4'>void</span><span class='opr'>[</span><span class='opr'>]</span> src<span class='opr'>)</span>
                <span class='opr'>{</span>
                        <span class='kw4'>int</span> count <span class='opr'>=</span> receiveFrom <span class='opr'>(</span>src, addr<span class='opr'>)</span>;
                        <span class='kw1'>if</span> <span class='opr'>(</span>count <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                            count <span class='opr'>=</span> IConduit.Eof;
                        <span class='kw1'>return</span> count;
                <span class='opr'>}</span>

                <span class='kw1'>return</span> target.write <span class='opr'>(</span><span class='opr'>&amp;</span>reader<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Read the available bytes from datagram into the given IBuffer.
                The 'from' address will be populated appropriately

        ***********************************************************************/</span>

        <span class='kw4'>uint</span> read <span class='opr'>(</span>IBuffer target<span class='opr'>)</span>
        <span class='opr'>{</span>
                Address addr;

                <span class='kw1'>return</span> read <span class='opr'>(</span>target, addr<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Is this socket still valid?

        ***********************************************************************/</span>

        <span class='kw4'>bool</span> isAlive <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> <span class='kw2'>super</span>.isAlive<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
       
                Write content from the specified buffer to the given address.
         
        ***********************************************************************/</span>

        <span class='kw4'>uint</span> write <span class='opr'>(</span>IBuffer source, Address to<span class='opr'>)</span>
        <span class='kw2'>in</span> <span class='opr'>{</span>
           <span class='kw2'>assert</span> <span class='opr'>(</span>to<span class='opr'>)</span>;
           <span class='kw2'>assert</span> <span class='opr'>(</span>source<span class='opr'>)</span>;
           <span class='opr'>}</span>
        <span class='kw2'>body</span>
        <span class='opr'>{</span>
                <span class='kw4'>uint</span> writer <span class='opr'>(</span><span class='kw4'>void</span><span class='opr'>[</span><span class='opr'>]</span> src<span class='opr'>)</span>
                <span class='opr'>{</span>
                        <span class='kw4'>int</span> count <span class='opr'>=</span> sendTo <span class='opr'>(</span>src, Flags.NONE, to<span class='opr'>)</span>;
                        <span class='kw1'>if</span> <span class='opr'>(</span>count <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                            count <span class='opr'>=</span> IConduit.Eof;
                        <span class='kw1'>return</span> count;
                <span class='opr'>}</span>

                <span class='kw4'>int</span> count <span class='opr'>=</span> source.read <span class='opr'>(</span><span class='opr'>&amp;</span>writer<span class='opr'>)</span>;

                <span class='com'>// if we didn't write everything, move remaining content</span>
                <span class='com'>// to front of buffer for a subsequent write</span>
                source.compress<span class='opr'>(</span><span class='opr'>)</span>;
                <span class='kw1'>return</span> count;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
       
                create a new socket for binding during another join(), since
                there doesn't appear to be a means of unbinding
         
        ***********************************************************************/</span>

        <span class='kw4'>protected</span> <span class='kw4'>override</span> <span class='kw4'>void</span> create <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span>.create <span class='opr'>(</span>AddressFamily.INET, Type.DGRAM, Protocol.IP<span class='opr'>)</span>;                
        <span class='opr'>}</span>
<span class='opr'>}</span>

</pre></td></tr></table>	</body>
</html>
