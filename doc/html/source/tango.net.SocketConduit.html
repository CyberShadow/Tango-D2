<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<title>SocketConduit.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)

        version:        Initial release: March 2004      
        version:        Jan 1st 2005 - Added RedShodan patch for timeout query
        
        author:         Kris

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.net.SocketConduit;

<span class='kw4'>public</span>  <span class='kw2'>import</span>  tango.net.Socket;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.io.model.IBuffer;


<span class='com'>/*******************************************************************************

        A wrapper around the bare Socket to implement the IConduit abstraction
        and add socket-specific functionality. SocketConduit data-transfer is 
        typically performed in conjunction with an IBuffer instance, but can 
        be handled directly using raw arrays if preferred. See FileConduit for 
        examples of both approaches.

*******************************************************************************/</span>

<span class='kw4'>class</span> SocketConduit : Socket, ISocketReader
<span class='opr'>{</span>       
        <span class='com'>// expose Conduit read()</span>
        <span class='kw2'>alias</span> Socket.read               read;

        <span class='com'>// freelist support</span>
        <span class='kw4'>private</span> SocketConduit           next;   
        <span class='kw4'>private</span> <span class='kw4'>bool</span>                    fromList;
        <span class='kw4'>private</span> <span class='kw4'>static</span> SocketConduit    freelist;

        <span class='com'>/***********************************************************************
        
                Create a streaming Internet Socket

        ***********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span> <span class='opr'>(</span>AddressFamily.INET, Type.STREAM, Protocol.IP<span class='opr'>)</span>;                
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************

                Override closure() to deallocate this SocketConduit 
                when it has been closed. Note that one should *not* 
                delete a SocketConduit when FreeList is enabled ...

        ***********************************************************************/</span>

        <span class='kw4'>override</span> <span class='kw4'>void</span> close <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>       
                <span class='com'>// be a nice client, and tell the server?</span>
                <span class='com'>//super.shutdown();</span>

                <span class='com'>// do this first cos' we're gonna' reset the</span>
                <span class='com'>// socket handle during deallocate()</span>
                <span class='kw2'>super</span>.close <span class='opr'>(</span><span class='opr'>)</span>;


                <span class='com'>// deallocate if this came from the free-list,</span>
                <span class='com'>// otherwise just wait for the GC to handle it</span>
                <span class='kw1'>if</span> <span class='opr'>(</span>fromList<span class='opr'>)</span>
                    deallocate <span class='opr'>(</span><span class='kw2'>this</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Read from conduit into a target buffer. Note that this 
                uses SocketSet to handle timeouts, such that the socket
                does not stall forever.
        
                (for the ISocketReader interface)

        ***********************************************************************/</span>

        <span class='kw4'>uint</span> read <span class='opr'>(</span>IBuffer target<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> target.fill <span class='opr'>(</span><span class='kw2'>this</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************

                Is this socket still alive?

        ***********************************************************************/</span>

        <span class='kw4'>bool</span> isAlive<span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> <span class='kw2'>super</span>.isAlive<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Construct this SocketConduit with the given socket handle;
                this is for FreeList and ServerSocket support.

        ***********************************************************************/</span>

        <span class='kw4'>protected</span> <span class='kw4'>static</span> SocketConduit create <span class='opr'>(</span>socket_t handle<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='com'>// allocate one from the free-list</span>
                <span class='kw1'>return</span> allocate <span class='opr'>(</span>handle<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
       
                Create a new socket for binding during another join() or
                connect(), since there doesn't appear to be another means
         
        ***********************************************************************/</span>

        <span class='kw4'>protected</span> <span class='kw4'>override</span> <span class='kw4'>void</span> create <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span>.create <span class='opr'>(</span>AddressFamily.INET, Type.STREAM, Protocol.IP<span class='opr'>)</span>;                
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Construct this SocketConduit with the given socket handle;
                this is for FreeList and ServerSocket support.

        ***********************************************************************/</span>

        <span class='kw4'>private</span> <span class='kw2'>this</span> <span class='opr'>(</span>socket_t handle<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span> <span class='opr'>(</span>handle<span class='opr'>)</span>;                
        <span class='opr'>}</span>
     
        <span class='com'>/***********************************************************************

                Allocate a SocketConduit from a list rather than 
                creating a new one

        ***********************************************************************/</span>

        <span class='kw4'>private</span> <span class='kw4'>static</span> <span class='kw4'>synchronized</span> SocketConduit allocate <span class='opr'>(</span>socket_t sock<span class='opr'>)</span>
        <span class='opr'>{</span>       
                SocketConduit s;

                <span class='kw1'>if</span> <span class='opr'>(</span>freelist<span class='opr'>)</span>
                   <span class='opr'>{</span>
                   s <span class='opr'>=</span> freelist;
                   freelist <span class='opr'>=</span> s.next;
                   s.set <span class='opr'>(</span>sock<span class='opr'>)</span>;
                   <span class='opr'>}</span>
                <span class='kw1'>else</span>
                   <span class='opr'>{</span>
                   s <span class='opr'>=</span> <span class='kw2'>new</span> SocketConduit <span class='opr'>(</span>sock<span class='opr'>)</span>;
                   s.fromList <span class='opr'>=</span> <span class='kw2'>true</span>;
                   <span class='opr'>}</span>
                <span class='kw1'>return</span> s;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************

                Return this SocketConduit to the free-list

        ***********************************************************************/</span>

        <span class='kw4'>private</span> <span class='kw4'>static</span> <span class='kw4'>synchronized</span> <span class='kw4'>void</span> deallocate <span class='opr'>(</span>SocketConduit s<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='com'>// socket handle is no longer valid</span>
                s.reset <span class='opr'>(</span><span class='opr'>)</span>;
                s.next <span class='opr'>=</span> freelist;
                freelist <span class='opr'>=</span> s;
        <span class='opr'>}</span>
<span class='opr'>}</span>


<span class='com'>/*******************************************************************************

        Creates a text-oriented socket

*******************************************************************************/</span>

<span class='kw4'>class</span> TextSocketConduit : SocketConduit
<span class='opr'>{</span>       
        <span class='kw2'>this</span> <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span><span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Returns true if this conduit is text-based

        ***********************************************************************/</span>

        <span class='kw4'>override</span> <span class='kw4'>bool</span> isTextual <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> <span class='kw2'>true</span>;
        <span class='opr'>}</span>               
<span class='opr'>}</span>



</pre></td></tr></table>	</body>
</html>
