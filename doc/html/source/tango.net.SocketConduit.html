<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<title>/SocketConduit.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
<span>43</span>
<span>44</span>
<span>45</span>
<span>46</span>
<span>47</span>
<span>48</span>
<span>49</span>
<span>50</span>
<span>51</span>
<span>52</span>
<span>53</span>
<span>54</span>
<span>55</span>
<span>56</span>
<span>57</span>
<span>58</span>
<span>59</span>
<span>60</span>
<span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)

        version:        Initial release: March 2004      
        version:        Jan 1st 2005 - Added RedShodan patch for timeout query
        
        author:         Kris

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.net.SocketConduit;

<span class='kw4'>public</span>  <span class='kw2'>import</span>  tango.net.Socket;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.io.Buffer;


<span class='com'>/*******************************************************************************

        A wrapper around the bare Socket to implement the IConduit abstraction
        and add socket-specific functionality. SocketConduit data-transfer is 
        typically performed in conjunction with an IBuffer instance, but can 
        be handled directly using raw arrays if preferred. See FileConduit for 
        examples of both approaches.

*******************************************************************************/</span>

<span class='kw4'>class</span> SocketConduit : Socket, ISocketReader
<span class='opr'>{</span>       
        <span class='com'>// expose Conduit read()</span>
        <span class='kw2'>alias</span> Socket.read               read;

        <span class='com'>// freelist support</span>
        <span class='kw4'>private</span> SocketConduit           next;   
        <span class='kw4'>private</span> <span class='kw4'>bool</span>                    fromList;
        <span class='kw4'>private</span> <span class='kw4'>static</span> SocketConduit    freelist;

        <span class='com'>/***********************************************************************
        
                Create a streaming Internet Socket

        ***********************************************************************/</span>

        <span class='kw2'>this</span> <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span> <span class='opr'>(</span>AddressFamily.INET, Type.STREAM, Protocol.IP<span class='opr'>)</span>;                
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************

                Override closure() to deallocate this SocketConduit 
                when it has been closed. Note that one should *not* 
                delete a SocketConduit when FreeList is enabled ...

        ***********************************************************************/</span>

        <span class='kw4'>override</span> <span class='kw4'>void</span> close <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>       
                <span class='com'>// be a nice client, and tell the server?</span>
                <span class='com'>//super.shutdown();</span>

                <span class='com'>// do this first cos' we're gonna' reset the</span>
                <span class='com'>// socket handle during deallocate()</span>
                <span class='kw2'>super</span>.close <span class='opr'>(</span><span class='opr'>)</span>;


                <span class='com'>// deallocate if this came from the free-list,</span>
                <span class='com'>// otherwise just wait for the GC to handle it</span>
                <span class='kw1'>if</span> <span class='opr'>(</span>fromList<span class='opr'>)</span>
                    deallocate <span class='opr'>(</span><span class='kw2'>this</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Read from conduit into a target buffer. Note that this 
                uses SocketSet to handle timeouts, such that the socket
                does not stall forever.
        
                (for the ISocketReader interface)

        ***********************************************************************/</span>

        <span class='kw4'>uint</span> read <span class='opr'>(</span>IBuffer target<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> target.fill <span class='opr'>(</span><span class='kw2'>this</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************

                Is this socket still alive?

        ***********************************************************************/</span>

        <span class='kw4'>bool</span> isAlive<span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> <span class='kw2'>super</span>.isAlive<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Construct this SocketConduit with the given socket handle;
                this is for FreeList and ServerSocket support.

        ***********************************************************************/</span>

        <span class='kw4'>protected</span> <span class='kw4'>static</span> SocketConduit create <span class='opr'>(</span>socket_t handle<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='com'>// allocate one from the free-list</span>
                <span class='kw1'>return</span> allocate <span class='opr'>(</span>handle<span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
       
                Create a new socket for binding during another join() or
                connect(), since there doesn't appear to be another means
         
        ***********************************************************************/</span>

        <span class='kw4'>protected</span> <span class='kw4'>override</span> <span class='kw4'>void</span> create <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span>.create <span class='opr'>(</span>AddressFamily.INET, Type.STREAM, Protocol.IP<span class='opr'>)</span>;                
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Construct this SocketConduit with the given socket handle;
                this is for FreeList and ServerSocket support.

        ***********************************************************************/</span>

        <span class='kw4'>private</span> <span class='kw2'>this</span> <span class='opr'>(</span>socket_t handle<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span> <span class='opr'>(</span>handle<span class='opr'>)</span>;                
        <span class='opr'>}</span>
     
        <span class='com'>/***********************************************************************

                Allocate a SocketConduit from a list rather than 
                creating a new one

        ***********************************************************************/</span>

        <span class='kw4'>private</span> <span class='kw4'>static</span> <span class='kw4'>synchronized</span> SocketConduit allocate <span class='opr'>(</span>socket_t sock<span class='opr'>)</span>
        <span class='opr'>{</span>       
                SocketConduit s;

                <span class='kw1'>if</span> <span class='opr'>(</span>freelist<span class='opr'>)</span>
                   <span class='opr'>{</span>
                   s <span class='opr'>=</span> freelist;
                   freelist <span class='opr'>=</span> s.next;
                   s.set <span class='opr'>(</span>sock<span class='opr'>)</span>;
                   <span class='opr'>}</span>
                <span class='kw1'>else</span>
                   <span class='opr'>{</span>
                   s <span class='opr'>=</span> <span class='kw2'>new</span> SocketConduit <span class='opr'>(</span>sock<span class='opr'>)</span>;
                   s.fromList <span class='opr'>=</span> <span class='kw2'>true</span>;
                   <span class='opr'>}</span>
                <span class='kw1'>return</span> s;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************

                Return this SocketConduit to the free-list

        ***********************************************************************/</span>

        <span class='kw4'>private</span> <span class='kw4'>static</span> <span class='kw4'>synchronized</span> <span class='kw4'>void</span> deallocate <span class='opr'>(</span>SocketConduit s<span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='com'>// socket handle is no longer valid</span>
                s.reset <span class='opr'>(</span><span class='opr'>)</span>;
                s.next <span class='opr'>=</span> freelist;
                freelist <span class='opr'>=</span> s;
        <span class='opr'>}</span>
<span class='opr'>}</span>


<span class='com'>/*******************************************************************************

        Creates a text-oriented socket

*******************************************************************************/</span>

<span class='kw4'>class</span> TextSocketConduit : SocketConduit
<span class='opr'>{</span>       
        <span class='kw2'>this</span> <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw2'>super</span><span class='opr'>(</span><span class='opr'>)</span>;
        <span class='opr'>}</span>

        <span class='com'>/***********************************************************************
        
                Returns true if this conduit is text-based

        ***********************************************************************/</span>

        <span class='kw4'>override</span> <span class='kw4'>bool</span> isTextual <span class='opr'>(</span><span class='opr'>)</span>
        <span class='opr'>{</span>
                <span class='kw1'>return</span> <span class='kw2'>true</span>;
        <span class='opr'>}</span>               
<span class='opr'>}</span>



</pre></td></tr></table>	</body>
</html>
