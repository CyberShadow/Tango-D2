<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<title>/ArgParser.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
<span>43</span>
<span>44</span>
<span>45</span>
<span>46</span>
<span>47</span>
<span>48</span>
<span>49</span>
<span>50</span>
<span>51</span>
<span>52</span>
<span>53</span>
<span>54</span>
<span>55</span>
<span>56</span>
<span>57</span>
<span>58</span>
<span>59</span>
<span>60</span>
<span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
</pre></td><td id='code'><pre><span class='com'>/+
    Copyright (c) 2005-2006 Eric Anderton, Lars Ivar Igesund

    Permission is hereby granted, free of charge, to any person
    obtaining a copy of this software and associated documentation
    files (the &quot;Software&quot;), to deal in the Software without
    restriction, including without limitation the rights to use,
    copy, modify, merge, publish, distribute, sublicense, and/or
    sell copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following
    conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
    OTHER DEALINGS IN THE SOFTWARE.
+/</span>
<span class='com'>/**
    This module holds a utility class that can parse your command 
    line arguments.

    A sample program would instantiate the ArgParser class, bind
    some delegates (can be anonymous), then call parse with the
    arguments as a parameter.

    Note that the delegates must return the correct number of
    consumed characters to ensure that the ArgParser operates correctly.
    Simple arguments that don't use the value parameter of the callback,
    should return 0 consumed characters. This behaviour will ensure that
    ArgParser will correctly handle all arguments, even when there are
    no space between them.

    Authors: Eric Anderton, Lars Ivar Igesund
    License: BSD Derivative (see source for details)
    Copyright: 2005-2006 Eric Anderton, Lars Ivar Igesund
*/</span>
<span class='kw2'>module</span> tango.text.ArgParser;

<span class='com'>/**
    An alias to a delegate taking a char[] as a parameter and returning
    an uint. The value parameter will hold any chars immediately
    following the argument. The returned value tell how many chars of 
    value was used by the callback.
*/</span>
<span class='kw2'>alias</span> <span class='kw4'>uint</span> <span class='kw2'>delegate</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> value<span class='opr'>)</span> ArgParserCallback;

<span class='com'>/**
    An alias to a delegate taking a char[] as a parameter and returning
    an uint. The value parameter will hold any chars immediately
    following the argument. The returned value tell how many chars of 
    value was used by the callback.
    
    The ordinal argument represents which default argument this is for
    the given stream of arguments.  The first default argument will
    be ordinal=0 with each successive call to this callback having
    ordinal values of 1, 2, 3 and so forth.
*/</span>
<span class='kw2'>alias</span> <span class='kw4'>uint</span> <span class='kw2'>delegate</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> value,<span class='kw4'>uint</span> ordinal<span class='opr'>)</span> DefaultArgParserCallback;

<span class='com'>/**
    An alias to a delegate taking no parameters and returning
    nothing.
*/</span>
<span class='kw2'>alias</span> <span class='kw4'>void</span> <span class='kw2'>delegate</span> <span class='opr'>(</span><span class='opr'>)</span> ArgParserSimpleCallback;

<span class='com'>/**
    A utility class to parse and handle your command line arguments.
*/</span>
<span class='kw4'>class</span> ArgParser<span class='opr'>{</span>
    <span class='com'>/**
        A helper struct containing a callback and an id to, corresponding to
        the argId passed to one of the bind methods.
    */</span>
    <span class='kw4'>protected</span> <span class='kw4'>struct</span> PrefixCallback <span class='opr'>{</span>
        <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> id;
        ArgParserCallback cb;
    <span class='opr'>}</span>    

    <span class='kw4'>protected</span> PrefixCallback<span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>]</span> bindings;
    <span class='kw4'>protected</span> DefaultArgParserCallback<span class='opr'>[</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>]</span> defaultBindings;
    <span class='kw4'>protected</span> <span class='kw4'>uint</span><span class='opr'>[</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>]</span> prefixOrdinals;
    <span class='kw4'>protected</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> prefixSearchOrder;
    <span class='kw4'>protected</span> DefaultArgParserCallback defaultbinding;

    <span class='kw4'>protected</span> <span class='kw4'>void</span> addBinding<span class='opr'>(</span>PrefixCallback pcb, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argPrefix<span class='opr'>)</span><span class='opr'>{</span>
        <span class='kw1'>if</span> <span class='opr'>(</span>!<span class='opr'>(</span>argPrefix <span class='kw2'>in</span> bindings<span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>{</span>
            prefixSearchOrder <span class='opr'>~=</span> argPrefix;
        <span class='opr'>}</span>
        bindings<span class='opr'>[</span>argPrefix<span class='opr'>]</span> <span class='opr'>~=</span> pcb;
    <span class='opr'>}</span>

    <span class='com'>/**
        Binds a delegate callback to argument with a prefix and 
        a argId.
        
        Params:
            argPrefix = the prefix of the argument, e.g. a dash '-'.
            argId = the name of the argument, what follows the prefix
            cb = the delegate that should be called when this argument is found
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> bind<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argPrefix, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argId, ArgParserCallback cb<span class='opr'>)</span><span class='opr'>{</span>
        PrefixCallback pcb;
        pcb.id <span class='opr'>=</span> argId;
        pcb.cb <span class='opr'>=</span> cb;
        addBinding<span class='opr'>(</span>pcb, argPrefix<span class='opr'>)</span>;
    <span class='opr'>}</span> 

    <span class='com'>/**
        The constructor, creates an empty ArgParser instance.
    */</span>
    <span class='kw4'>public</span> <span class='kw2'>this</span><span class='opr'>(</span><span class='opr'>)</span><span class='opr'>{</span>
        defaultbinding <span class='opr'>=</span> <span class='kw2'>null</span>;
    <span class='opr'>}</span>
     
    <span class='com'>/**
        The constructor, creates an ArgParser instance with a defined default callback.
    */</span>    
    <span class='kw4'>public</span> <span class='kw2'>this</span><span class='opr'>(</span>DefaultArgParserCallback callback<span class='opr'>)</span><span class='opr'>{</span>
        defaultbinding <span class='opr'>=</span> callback;
    <span class='opr'>}</span>    

    <span class='kw4'>protected</span> <span class='kw4'>class</span> SimpleCallbackAdapter<span class='opr'>{</span>
        ArgParserSimpleCallback callback;
        <span class='kw4'>public</span> <span class='kw2'>this</span><span class='opr'>(</span>ArgParserSimpleCallback callback<span class='opr'>)</span><span class='opr'>{</span> 
            <span class='kw2'>this</span>.callback <span class='opr'>=</span> callback; 
        <span class='opr'>}</span>
        
        <span class='kw4'>public</span> <span class='kw4'>uint</span> adapterCallback<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> value<span class='opr'>)</span><span class='opr'>{</span>
            callback<span class='opr'>(</span><span class='opr'>)</span>;
            <span class='kw1'>return</span> <span class='nbr'>0</span>;
        <span class='opr'>}</span>
    <span class='opr'>}</span>

    <span class='com'>/**
        Binds a delegate callback to argument with a prefix and 
        a argId.
        
        Params:
            argPrefix = the prefix of the argument, e.g. a dash '-'.
            argId = the name of the argument, what follows the prefix
            cb = the delegate that should be called when this argument is found
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> bind<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argPrefix, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argId, ArgParserSimpleCallback cb<span class='opr'>)</span><span class='opr'>{</span>
        SimpleCallbackAdapter adapter <span class='opr'>=</span> <span class='kw2'>new</span> SimpleCallbackAdapter<span class='opr'>(</span>cb<span class='opr'>)</span>;
        PrefixCallback pcb;
        pcb.id <span class='opr'>=</span> argId;
        pcb.cb <span class='opr'>=</span> <span class='opr'>&amp;</span>adapter.adapterCallback;
        addBinding<span class='opr'>(</span>pcb, argPrefix<span class='opr'>)</span>;
    <span class='opr'>}</span>
    
    <span class='com'>/**
        Binds a delegate callback to all arguments with prefix argPrefix, but that
        do not conform to an argument bound in a call to bind(). 

        Params:
            argPrefix = the prefix for the callback
            callback = the default callback
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> bindDefault<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argPrefix, DefaultArgParserCallback callback<span class='opr'>)</span><span class='opr'>{</span>
        defaultBindings<span class='opr'>[</span>argPrefix<span class='opr'>]</span> <span class='opr'>=</span> callback;
        prefixOrdinals<span class='opr'>[</span>argPrefix<span class='opr'>]</span> <span class='opr'>=</span> <span class='nbr'>0</span>;
    <span class='opr'>}</span>

    <span class='com'>/**
        Binds a delegate callback to all arguments not conforming to an
        argument bound in a call to bind(). These arguments will be passed to the
        delegate without having any matching prefixes removed.

        Params:
            callback = the default callback
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> bindDefault<span class='opr'>(</span>DefaultArgParserCallback callback<span class='opr'>)</span><span class='opr'>{</span>
        defaultbinding <span class='opr'>=</span> callback;
    <span class='opr'>}</span>

    <span class='com'>/**
        Parses the arguments provided by the parameter. The bound
        callbacks are called as arguments are recognized.

        Params:
            arguments = the command line arguments from the application
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> parse<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> arguments<span class='opr'>)</span><span class='opr'>{</span>
        <span class='kw4'>uint</span> defaultOrdinal <span class='opr'>=</span> <span class='nbr'>0</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>bindings.length <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='kw1'>return</span>;

        <span class='kw1'>foreach</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> arg; arguments<span class='opr'>)</span> <span class='opr'>{</span>
            <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argData <span class='opr'>=</span> arg;
            <span class='kw1'>while</span> <span class='opr'>(</span>argData.length <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
                <span class='kw4'>bool</span> found <span class='opr'>=</span> <span class='kw2'>false</span>;
                <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argOrig <span class='opr'>=</span> argData;
                <span class='kw1'>foreach</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> prefix; prefixSearchOrder<span class='opr'>)</span> <span class='opr'>{</span>
                    <span class='kw1'>if</span><span class='opr'>(</span>argData.length <span class='opr'>&lt;</span> prefix.length<span class='opr'>)</span> <span class='kw1'>continue</span>; 
                    <span class='kw1'>if</span><span class='opr'>(</span>argData<span class='opr'>[</span><span class='nbr'>0.</span>.prefix.length<span class='opr'>]</span> <span class='opr'>!=</span> prefix<span class='opr'>)</span> <span class='opr'>{</span>
                        <span class='kw1'>continue</span>;
                    <span class='opr'>}</span>
                    <span class='kw1'>else</span> <span class='opr'>{</span>
                        argData <span class='opr'>=</span> argData<span class='opr'>[</span>prefix.length<span class='opr'>..</span>$<span class='opr'>]</span>;
                    <span class='opr'>}</span> 
                    <span class='kw1'>foreach</span> <span class='opr'>(</span>PrefixCallback cb; bindings<span class='opr'>[</span>prefix<span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>{</span>
                        <span class='kw1'>if</span> <span class='opr'>(</span>argData.length <span class='opr'>&lt;</span> cb.id.length<span class='opr'>)</span> <span class='kw1'>continue</span>;
                        <span class='kw4'>uint</span> cbil <span class='opr'>=</span> cb.id.length;
                        <span class='kw1'>if</span> <span class='opr'>(</span>cb.id <span class='opr'>=</span><span class='opr'>=</span> argData<span class='opr'>[</span><span class='nbr'>0.</span>.cbil<span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>{</span>
                            found <span class='opr'>=</span> <span class='kw2'>true</span>;
                            argData <span class='opr'>=</span> argData<span class='opr'>[</span>cbil<span class='opr'>..</span>$<span class='opr'>]</span>;
                            <span class='kw4'>uint</span> consumed <span class='opr'>=</span> cb.cb<span class='opr'>(</span>argData<span class='opr'>)</span>;
                            argData <span class='opr'>=</span> argData<span class='opr'>[</span>consumed<span class='opr'>..</span>$<span class='opr'>]</span>;
                            <span class='kw1'>break</span>;
                        <span class='opr'>}</span>
                    <span class='opr'>}</span>
                    <span class='kw1'>if</span> <span class='opr'>(</span>found<span class='opr'>)</span> <span class='opr'>{</span>
                        <span class='kw1'>break</span>;
                    <span class='opr'>}</span>
                    <span class='kw1'>else</span> <span class='kw1'>if</span> <span class='opr'>(</span>prefix <span class='kw2'>in</span> defaultBindings<span class='opr'>)</span><span class='opr'>{</span>
                        <span class='kw4'>uint</span> consumed <span class='opr'>=</span> defaultBindings<span class='opr'>[</span>prefix<span class='opr'>]</span><span class='opr'>(</span>argData,prefixOrdinals<span class='opr'>[</span>prefix<span class='opr'>]</span><span class='opr'>)</span>;
                        argData <span class='opr'>=</span> argData<span class='opr'>[</span>consumed<span class='opr'>..</span>$<span class='opr'>]</span>;
                        prefixOrdinals<span class='opr'>[</span>prefix<span class='opr'>]</span><span class='opr'>+</span><span class='opr'>+</span>;
                        <span class='kw1'>break</span>;
                    <span class='opr'>}</span>
                    argData <span class='opr'>=</span> argOrig;
                <span class='opr'>}</span>
                <span class='kw1'>if</span> <span class='opr'>(</span>!found<span class='opr'>)</span> <span class='opr'>{</span>
                    <span class='kw1'>if</span> <span class='opr'>(</span>!<span class='opr'>(</span>defaultbinding <span class='kw2'>is</span> <span class='kw2'>null</span><span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>{</span>
                        <span class='kw4'>uint</span> consumed <span class='opr'>=</span> defaultbinding<span class='opr'>(</span>argData,defaultOrdinal<span class='opr'>)</span>;
                        argData <span class='opr'>=</span> argData<span class='opr'>[</span>consumed<span class='opr'>..</span>$<span class='opr'>]</span>;
                        defaultOrdinal<span class='opr'>+</span><span class='opr'>+</span>;
                    <span class='opr'>}</span>
                    <span class='kw1'>else</span> <span class='opr'>{</span>
                        <span class='kw2'>throw</span> <span class='kw2'>new</span> Exception<span class='opr'>(</span><span class='str'>&quot;Illegal argument &quot;</span>
                                  <span class='opr'>~</span> argData<span class='opr'>)</span>;
                    <span class='opr'>}</span>
                <span class='opr'>}</span>
            <span class='opr'>}</span>
        <span class='opr'>}</span>
    <span class='opr'>}</span>
<span class='opr'>}</span>
</pre></td></tr></table>	</body>
</html>
