<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<title>ArgParser.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
</pre></td><td id='code'><pre><span class='com'>/*******************************************************************************

        copyright:      Copyright (c) 2005 - 2006 Eric Anderton, 
                        Lars Ivar Igesund. All rights reserved

        license:        BSD style: $(LICENSE)

        version:        Initial release: October 2005      
        
        author:         Eric Anderton, Lars Ivar Igesund

        This module defines a utility class that can parse your 
        command line arguments.

        A sample program would instantiate the ArgParser class, 
        bind some delegates (can be anonymous), then call parse 
        with the arguments as a parameter.

        Note that the delegates must return the correct number of
        consumed characters to ensure that the ArgParser operates 
        correctly. Simple arguments that don't use the value parameter 
        of the callback, should return 0 consumed characters. This 
        behaviour will ensure that ArgParser will correctly handle 
        all arguments, even when there are no space between them.

*******************************************************************************/</span>

<span class='kw2'>module</span> tango.text.ArgParser;

<span class='com'>/**
    An alias to a delegate taking a char[] as a parameter and returning
    an uint. The value parameter will hold any chars immediately
    following the argument. The returned value tell how many chars of 
    value was used by the callback.
*/</span>
<span class='kw2'>alias</span> <span class='kw4'>uint</span> <span class='kw2'>delegate</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> value<span class='opr'>)</span> ArgParserCallback;

<span class='com'>/**
    An alias to a delegate taking a char[] as a parameter and returning
    an uint. The value parameter will hold any chars immediately
    following the argument. The returned value tell how many chars of 
    value was used by the callback.
    
    The ordinal argument represents which default argument this is for
    the given stream of arguments.  The first default argument will
    be ordinal=0 with each successive call to this callback having
    ordinal values of 1, 2, 3 and so forth.
*/</span>
<span class='kw2'>alias</span> <span class='kw4'>uint</span> <span class='kw2'>delegate</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> value,<span class='kw4'>uint</span> ordinal<span class='opr'>)</span> DefaultArgParserCallback;

<span class='com'>/**
    An alias to a delegate taking no parameters and returning
    nothing.
*/</span>
<span class='kw2'>alias</span> <span class='kw4'>void</span> <span class='kw2'>delegate</span> <span class='opr'>(</span><span class='opr'>)</span> ArgParserSimpleCallback;

<span class='com'>/**
    A utility class to parse and handle your command line arguments.
*/</span>
<span class='kw4'>class</span> ArgParser<span class='opr'>{</span>
        <span class='com'>/**
            A helper struct containing a callback and an id to, corresponding to
            the argId passed to one of the bind methods.
        */</span>
        <span class='kw4'>protected</span> <span class='kw4'>struct</span> PrefixCallback <span class='opr'>{</span>
            <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> id;
            ArgParserCallback cb;
        <span class='opr'>}</span>       

    <span class='kw4'>protected</span> PrefixCallback<span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>]</span> bindings;
    <span class='kw4'>protected</span> DefaultArgParserCallback<span class='opr'>[</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>]</span> defaultBindings;
    <span class='kw4'>protected</span> <span class='kw4'>uint</span><span class='opr'>[</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>]</span> prefixOrdinals;
    <span class='kw4'>protected</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> prefixSearchOrder;
    <span class='kw4'>protected</span> DefaultArgParserCallback defaultbinding;

    <span class='kw4'>protected</span> <span class='kw4'>void</span> addBinding<span class='opr'>(</span>PrefixCallback pcb, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argPrefix<span class='opr'>)</span><span class='opr'>{</span>
        <span class='kw1'>if</span> <span class='opr'>(</span>!<span class='opr'>(</span>argPrefix <span class='kw2'>in</span> bindings<span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>{</span>
            prefixSearchOrder <span class='opr'>~=</span> argPrefix;
        <span class='opr'>}</span>
        bindings<span class='opr'>[</span>argPrefix<span class='opr'>]</span> <span class='opr'>~=</span> pcb;
    <span class='opr'>}</span>

    <span class='com'>/**
        Binds a delegate callback to argument with a prefix and 
        a argId.
        
        Params:
            argPrefix = the prefix of the argument, e.g. a dash '-'.
            argId = the name of the argument, what follows the prefix
            cb = the delegate that should be called when this argument is found
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> bind<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argPrefix, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argId, ArgParserCallback cb<span class='opr'>)</span><span class='opr'>{</span>
        PrefixCallback pcb;
        pcb.id <span class='opr'>=</span> argId;
        pcb.cb <span class='opr'>=</span> cb;
        addBinding<span class='opr'>(</span>pcb, argPrefix<span class='opr'>)</span>;
    <span class='opr'>}</span> 

    <span class='com'>/**
        The constructor, creates an empty ArgParser instance.
    */</span>
    <span class='kw4'>public</span> <span class='kw2'>this</span><span class='opr'>(</span><span class='opr'>)</span><span class='opr'>{</span>
        defaultbinding <span class='opr'>=</span> <span class='kw2'>null</span>;
    <span class='opr'>}</span>
     
    <span class='com'>/**
        The constructor, creates an ArgParser instance with a defined default callback.
    */</span>    
    <span class='kw4'>public</span> <span class='kw2'>this</span><span class='opr'>(</span>DefaultArgParserCallback callback<span class='opr'>)</span><span class='opr'>{</span>
        defaultbinding <span class='opr'>=</span> callback;
    <span class='opr'>}</span>    

    <span class='kw4'>protected</span> <span class='kw4'>class</span> SimpleCallbackAdapter<span class='opr'>{</span>
        ArgParserSimpleCallback callback;
        <span class='kw4'>public</span> <span class='kw2'>this</span><span class='opr'>(</span>ArgParserSimpleCallback callback<span class='opr'>)</span><span class='opr'>{</span> 
            <span class='kw2'>this</span>.callback <span class='opr'>=</span> callback; 
        <span class='opr'>}</span>
        
        <span class='kw4'>public</span> <span class='kw4'>uint</span> adapterCallback<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> value<span class='opr'>)</span><span class='opr'>{</span>
            callback<span class='opr'>(</span><span class='opr'>)</span>;
            <span class='kw1'>return</span> <span class='nbr'>0</span>;
        <span class='opr'>}</span>
    <span class='opr'>}</span>

    <span class='com'>/**
        Binds a delegate callback to argument with a prefix and 
        a argId.
        
        Params:
            argPrefix = the prefix of the argument, e.g. a dash '-'.
            argId = the name of the argument, what follows the prefix
            cb = the delegate that should be called when this argument is found
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> bind<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argPrefix, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argId, ArgParserSimpleCallback cb<span class='opr'>)</span><span class='opr'>{</span>
        SimpleCallbackAdapter adapter <span class='opr'>=</span> <span class='kw2'>new</span> SimpleCallbackAdapter<span class='opr'>(</span>cb<span class='opr'>)</span>;
        PrefixCallback pcb;
        pcb.id <span class='opr'>=</span> argId;
        pcb.cb <span class='opr'>=</span> <span class='opr'>&amp;</span>adapter.adapterCallback;
        addBinding<span class='opr'>(</span>pcb, argPrefix<span class='opr'>)</span>;
    <span class='opr'>}</span>
    
    <span class='com'>/**
        Binds a delegate callback to all arguments with prefix argPrefix, but that
        do not conform to an argument bound in a call to bind(). 

        Params:
            argPrefix = the prefix for the callback
            callback = the default callback
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> bindDefault<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argPrefix, DefaultArgParserCallback callback<span class='opr'>)</span><span class='opr'>{</span>
        defaultBindings<span class='opr'>[</span>argPrefix<span class='opr'>]</span> <span class='opr'>=</span> callback;
        prefixOrdinals<span class='opr'>[</span>argPrefix<span class='opr'>]</span> <span class='opr'>=</span> <span class='nbr'>0</span>;
    <span class='opr'>}</span>

    <span class='com'>/**
        Binds a delegate callback to all arguments not conforming to an
        argument bound in a call to bind(). These arguments will be passed to the
        delegate without having any matching prefixes removed.

        Params:
            callback = the default callback
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> bindDefault<span class='opr'>(</span>DefaultArgParserCallback callback<span class='opr'>)</span><span class='opr'>{</span>
        defaultbinding <span class='opr'>=</span> callback;
    <span class='opr'>}</span>

    <span class='com'>/**
        Parses the arguments provided by the parameter. The bound
        callbacks are called as arguments are recognized.

        Params:
            arguments = the command line arguments from the application
    */</span>
    <span class='kw4'>public</span> <span class='kw4'>void</span> parse<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> arguments<span class='opr'>)</span><span class='opr'>{</span>
            <span class='kw4'>uint</span> defaultOrdinal <span class='opr'>=</span> <span class='nbr'>0</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>bindings.length <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='kw1'>return</span>;

        <span class='kw1'>foreach</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> arg; arguments<span class='opr'>)</span> <span class='opr'>{</span>
            <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argData <span class='opr'>=</span> arg;
            <span class='kw1'>while</span> <span class='opr'>(</span>argData.length <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
                <span class='kw4'>bool</span> found <span class='opr'>=</span> <span class='kw2'>false</span>;
                <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> argOrig <span class='opr'>=</span> argData;
                <span class='kw1'>foreach</span> <span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> prefix; prefixSearchOrder<span class='opr'>)</span> <span class='opr'>{</span>
                    <span class='kw1'>if</span><span class='opr'>(</span>argData.length <span class='opr'>&lt;</span> prefix.length<span class='opr'>)</span> <span class='kw1'>continue</span>; 
                    <span class='kw1'>if</span><span class='opr'>(</span>argData<span class='opr'>[</span><span class='nbr'>0.</span>.prefix.length<span class='opr'>]</span> <span class='opr'>!=</span> prefix<span class='opr'>)</span> <span class='opr'>{</span>
                        <span class='kw1'>continue</span>;
                    <span class='opr'>}</span>
                    <span class='kw1'>else</span> <span class='opr'>{</span>
                        argData <span class='opr'>=</span> argData<span class='opr'>[</span>prefix.length<span class='opr'>..</span>$<span class='opr'>]</span>;
                    <span class='opr'>}</span> 
                    <span class='kw1'>foreach</span> <span class='opr'>(</span>PrefixCallback cb; bindings<span class='opr'>[</span>prefix<span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>{</span>
                        <span class='kw1'>if</span> <span class='opr'>(</span>argData.length <span class='opr'>&lt;</span> cb.id.length<span class='opr'>)</span> <span class='kw1'>continue</span>;
                        <span class='kw4'>uint</span> cbil <span class='opr'>=</span> cb.id.length;
                        <span class='kw1'>if</span> <span class='opr'>(</span>cb.id <span class='opr'>=</span><span class='opr'>=</span> argData<span class='opr'>[</span><span class='nbr'>0.</span>.cbil<span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>{</span>
                            found <span class='opr'>=</span> <span class='kw2'>true</span>;
                            argData <span class='opr'>=</span> argData<span class='opr'>[</span>cbil<span class='opr'>..</span>$<span class='opr'>]</span>;
                            <span class='kw4'>uint</span> consumed <span class='opr'>=</span> cb.cb<span class='opr'>(</span>argData<span class='opr'>)</span>;
                            argData <span class='opr'>=</span> argData<span class='opr'>[</span>consumed<span class='opr'>..</span>$<span class='opr'>]</span>;
                            <span class='kw1'>break</span>;
                        <span class='opr'>}</span>
                    <span class='opr'>}</span>
                    <span class='kw1'>if</span> <span class='opr'>(</span>found<span class='opr'>)</span> <span class='opr'>{</span>
                        <span class='kw1'>break</span>;
                    <span class='opr'>}</span>
                    <span class='kw1'>else</span> <span class='kw1'>if</span> <span class='opr'>(</span>prefix <span class='kw2'>in</span> defaultBindings<span class='opr'>)</span><span class='opr'>{</span>
                        <span class='kw4'>uint</span> consumed <span class='opr'>=</span> defaultBindings<span class='opr'>[</span>prefix<span class='opr'>]</span><span class='opr'>(</span>argData,prefixOrdinals<span class='opr'>[</span>prefix<span class='opr'>]</span><span class='opr'>)</span>;
                        argData <span class='opr'>=</span> argData<span class='opr'>[</span>consumed<span class='opr'>..</span>$<span class='opr'>]</span>;
                        prefixOrdinals<span class='opr'>[</span>prefix<span class='opr'>]</span><span class='opr'>+</span><span class='opr'>+</span>;
                        <span class='kw1'>break</span>;
                    <span class='opr'>}</span>
                    argData <span class='opr'>=</span> argOrig;
                <span class='opr'>}</span>
                <span class='kw1'>if</span> <span class='opr'>(</span>!found<span class='opr'>)</span> <span class='opr'>{</span>
                    <span class='kw1'>if</span> <span class='opr'>(</span>!<span class='opr'>(</span>defaultbinding <span class='kw2'>is</span> <span class='kw2'>null</span><span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>{</span>
                        <span class='kw4'>uint</span> consumed <span class='opr'>=</span> defaultbinding<span class='opr'>(</span>argData,defaultOrdinal<span class='opr'>)</span>;
                        argData <span class='opr'>=</span> argData<span class='opr'>[</span>consumed<span class='opr'>..</span>$<span class='opr'>]</span>;
                        defaultOrdinal<span class='opr'>+</span><span class='opr'>+</span>;
                    <span class='opr'>}</span>
                    <span class='kw1'>else</span> <span class='opr'>{</span>
                        <span class='kw2'>throw</span> <span class='kw2'>new</span> Exception<span class='opr'>(</span><span class='str'>&quot;Illegal argument &quot;</span>
                                  <span class='opr'>~</span> argData<span class='opr'>)</span>;
                    <span class='opr'>}</span>
                <span class='opr'>}</span>
            <span class='opr'>}</span>
        <span class='opr'>}</span>
    <span class='opr'>}</span>
<span class='opr'>}</span>
</pre></td></tr></table>	</body>
</html>
